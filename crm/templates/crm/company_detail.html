{% extends 'base.html' %}
{% load static %}
{% load crm_tags %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/company_detail.css' %}" />
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css"
/>
<style>
  /* Simple hover effect for activity type cards */
  .activity-type-card {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    margin-bottom: 0;
    border: 1px solid #dee2e6;
    transform: translateY(0);
  }
  .activity-type-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    background-color: #f8f9fa;
  }
  .activity-type-card.active {
    border: 2px solid #4e73df;
    background-color: #eef2ff;
  }

  /* Activity Timeline Styling */
  .timeline {
    position: relative;
  }
  
  .timeline-item {
    position: relative;
    padding: 1rem;
    background-color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    margin-bottom: 1.5rem;
    border-left-width: 4px !important;
    border-left-style: solid;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 1.5rem;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fff;
    border: 2px solid;
  }
  
  .timeline-item.border-success::before {
    border-color: #198754;
  }
  
  .timeline-item.border-warning::before {
    border-color: #ffc107;
  }
  
  .timeline-item.border-danger::before {
    border-color: #dc3545;
  }
  
  .timeline-item.border-info::before {
    border-color: #0dcaf0;
  }
  
  .timeline-item.border-primary::before {
    border-color: #0d6efd;
  }
  
  /* Border colors */
  .timeline-item.border-success {
    border-left-color: #198754;
  }
  
  .timeline-item.border-warning {
    border-left-color: #ffc107;
  }
  
  .timeline-item.border-danger {
    border-left-color: #dc3545;
  }
  
  .timeline-item.border-info {
    border-left-color: #0dcaf0;
  }
  
  .timeline-item.border-primary {
    border-left-color: #0d6efd;
  }
  
  /* White-space preserving for activity descriptions */
  .timeline-item p.mb-0 {
    white-space: pre-line;
  }
  
  /* Activity Content Card Styling */
  .activity-card {
    transition: all 0.2s ease;
    border-width: 1px;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .activity-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .activity-card .card-body {
    padding: 0.75rem 1rem;
  }
  
  /* Type-specific styling */
  .activity-card.bg-primary.bg-opacity-10 {
    border-color: rgba(13, 110, 253, 0.3);
  }
  
  .activity-card.bg-success.bg-opacity-10 {
    border-color: rgba(25, 135, 84, 0.3);
  }
  
  .activity-card.bg-warning.bg-opacity-10 {
    border-color: rgba(255, 193, 7, 0.3);
  }
  
  .activity-card.bg-danger.bg-opacity-10 {
    border-color: rgba(220, 53, 69, 0.3);
  }
  
  /* Content preview */
  .content-preview {
    color: #495057;
    font-size: 0.85rem;
    line-height: 1.3;
    margin-bottom: 0;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Timeline styling */
  .timeline-icon {
    position: absolute;
    left: -40px;
    top: 20px;
    width: 30px;
    height: 30px;
    background-color: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #dee2e6;
  }
  
  .timeline-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  
  .timeline-body {
    padding: 10px 0;
  }
  
  .user-icon {
    font-size: 0.9rem;
    color: #6c757d;
  }
</style>
{% endblock %}

{% block content %}
<!-- Company Profile Header -->
<div class="profile-header bg-gradient-blue-purple-left text-white py-4 mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2">{{ company.company_name }}</h1>
        <p class="mb-0">
          <i class="fas fa-building me-2"></i>
          {{ company.industry }}
          <span class="mx-2">|</span>
          <i class="fas fa-map-marker-alt me-2"></i>
          {{ company.city }}, {{ company.country }}
        </p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="{% url 'crm:company_list' %}" class="btn btn-light me-2">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
        <a href="{% url 'crm:company_update' company.pk %}" class="btn btn-light me-2">
          <i class="fas fa-edit"></i>
          Edit
        </a>
        <a href="{% url 'crm:contact_create' company_id=company.pk %}" class="btn btn-light">
          <i class="fas fa-user-plus"></i>
          Add Contact
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mb-5">
  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-4" id="companyTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">
        <i class="fas fa-info-circle me-2"></i>
        Overview
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="contacts-tab" data-bs-toggle="tab" href="#contacts" role="tab">
        <i class="fas fa-users me-2"></i>
        Contacts
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents" role="tab">
        <i class="fas fa-file-alt me-2"></i>
        Documents
      </a>
    </li>
    {% if company.company_type == 'Client' %}
    <li class="nav-item">
      <a
        class="nav-link"
        id="travel-policies-tab"
        data-bs-toggle="tab"
        href="#travel-policies"
        role="tab"
      >
        <i class="fas fa-plane me-2"></i>
        Travel Policies
      </a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link" id="activities-tab" data-bs-toggle="tab" href="#activities" role="tab">
        <i class="fas fa-chart-line me-2"></i>
        Activities
      </a>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="companyTabsContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-4">
          <!-- Basic Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Company Type</div>
                <div class="col-sm-7">{{ company.company_type }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Industry</div>
                <div class="col-sm-7">{{ company.industry }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Email</div>
                <div class="col-sm-7">
                  <a href="mailto:{{ company.email }}">{{ company.email }}</a>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Phone</div>
                <div class="col-sm-7">
                  <a href="tel:{{ company.phone_number }}">{{ company.phone_number }}</a>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-5 text-muted">LinkedIn</div>
                <div class="col-sm-7">
                  {% if company.linkedin_social_page %}
                  <a href="{{ company.linkedin_social_page }}" target="_blank">
                    <i class="fab fa-linkedin"></i>
                    View Profile
                  </a>
                  {% else %}
                  <span class="text-muted">Not provided</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Address Information</h5>
            </div>
            <div class="card-body">
              <address class="mb-0">
                {{ company.street_address }}
                <br />
                {{ company.city }}, {{ company.state_province }} {{ company.postal_code }}
                <br />
                {{ company.country }}
              </address>
            </div>
          </div>

          <!-- Description -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Description</h5>
            </div>
            <div class="card-body">
              <p class="mb-0">{{ company.description|default:"No description provided." }}</p>
            </div>
          </div>

          {% if company.company_type == 'Client' or company.company_type == 'Supplier' %}
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Linked Companies</h5>
              <a
                href="{% url 'crm:manage_company_relationships' company.id %}"
                class="btn btn-primary btn-sm"
              >
                <i class="fas fa-link"></i>
                Manage
              </a>
            </div>
            <div class="card-body">
              {% if company.from_relationships.exists or company.to_relationships.exists %}
              <div class="list-group list-group-flush">
                {% for rel in company.from_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.to_company.id %}">
                          {{ rel.to_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Outgoing</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
                
                {% for rel in company.to_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.from_company.id %}">
                          {{ rel.from_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Incoming</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted">
                No linked companies found. Use the "Manage" button to link this company to others.
              </p>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header text-white card-header-primary">
              <h5 class="mb-0">
                {% if company.company_type == 'Client' %}
                Client
                {% else %}
                Supplier
                {% endif %}
                Profile
              </h5>
            </div>
            <div class="card-body">
              <!-- Basic Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                <div class="row">
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}Client{% else %}Supplier{% endif %}
                        Type
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_type }}
                        {% else %}
                          {{ company.supplier_profile.supplier_type }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">Status</label>
                      <span class="badge bg-primary">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_status }}
                        {% else %}
                          {{ company.supplier_profile.supplier_status }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Operations Team
                        {% else %}
                          Department
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_ops_team|default:"Not assigned" }}
                        {% else %}
                          {{ company.supplier_profile.supplier_for_department }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Account Manager
                        {% else %}
                          Owner
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {% if company.client_profile.client_account_manager %}
                            {{ company.client_profile.client_account_manager.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% else %}
                          {% if company.supplier_profile.supplier_owner %}
                            {{ company.supplier_profile.supplier_owner.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Finance/Invoice Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Finance/Invoice Information</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="text-muted d-block">Sage Name</label>
                      <span class="fs-6">
                        {{ company.client_profile.sage_name|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Midoco CRM Number</label>
                      <span class="fs-6">
                        {{ company.client_profile.midoco_crm_number|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoice References</label>
                      {% if company.client_profile.invoice_reference_options.exists %}
                      <div class="mt-2">
                        {% for reference in company.client_profile.invoice_reference_options.all %}
                        <div class="badge bg-primary me-1 mb-1">
                          {{ reference.name }}
                          {% for client_ref in reference.clientinvoicereference_set.all %}
                            {% if client_ref.client_profile == company.client_profile %}
                            <span class="badge {% if client_ref.is_mandatory %}bg-danger{% else %}bg-secondary{% endif %} ms-1">
                              {% if client_ref.is_mandatory %}Mandatory{% else %}Optional{% endif %}
                            </span>
                            {% endif %}
                          {% endfor %}
                        </div>
                        {% endfor %}
                        
                        {% if not company.client_profile.invoice_reference_options.all %}
                          <span class="text-muted">No references set</span>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                  
                  <div class="col-md-{% if company.company_type == 'Client' %}6{% else %}12{% endif %}">
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Type</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_type|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_type|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Frequency</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_frequency|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_frequency|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Payment Terms</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.payment_terms|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.payment_terms|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {% if company.company_type == 'Client' %}
              <!-- Corporate Benefits -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Corporate Benefits</h6>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Hotel Rates</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_hotel_rates|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Airline Fares</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_airline_fares|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Memberships</label>
                      <span class="fs-6">
                        {{ company.client_profile.company_memberships|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Service Status -->
              <div class="profile-section">
                <h6 class="border-bottom pb-2 mb-3">Service Status</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.has_new_contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Contract Signed</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_corporate_schemes %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Corporate Schemes</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.meetings_events_requirements %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Meetings & Events Requirements</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.reporting_standard_bespoke %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Standard/Bespoke Reporting</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.access_to_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Access to Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.travel_policy_health_check_offered %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travel Policy Health Check Offered</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.testimonial_requested %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Testimonial Requested</span>
                      </li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="border-bottom pb-2 mb-3">Sustainability Information</h6>
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.communicated_esg_support %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>ESG Support Communicated</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.receive_co2_reporting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>CO2 Reporting</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.discussed_offsetting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Offsetting Discussed</span>
                      </li>
                    </ul>
                  </div>
                  {% else %}
                  <div class="col-12">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.new_supplier_form_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Supplier Form Signed</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Contract Signed</span>
                      </li>
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <table id="company-contacts-table" class="table table-striped">
            <thead>
              <tr>
                <th>Name</th>
                <th>Job Role</th>
                <th>Tags</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for contact in contacts %}
              <tr>
                <td>
                  <a href="{% url 'crm:contact_detail' contact.pk %}" class="fw-bold link-color">
                    {{ contact.first_name }} {{ contact.last_name }}
                  </a>
                </td>
                <td>{{ contact.job_role }}</td>
                <td>
                  {% for tag in contact.tag_list %}
                  <span
                    class="badge me-1 {% if tag == 'primary' %}bg-primary{% elif tag == 'key_personnel' %}bg-success{% elif tag == 'booker' %}bg-warning text-dark{% elif tag == 'vip_traveller' %}bg-warning{% elif tag == 'traveller' %}bg-info{% else %}bg-secondary{% endif %}"
                  >
                    {% if tag == 'primary' %} 
                      Primary Contact 
                    {% elif tag == 'key_personnel' %}
                      Key Personnel 
                    {% elif tag == 'booker' %} 
                      Booker 
                    {% elif tag == 'vip_traveller' %}
                      VIP Traveller 
                    {% elif tag == 'traveller' %} 
                      Traveller 
                    {% else %} 
                      {{ tag }}
                    {% endif %}
                  </span>
                  {% endfor %}
                </td>
                <td>
                  <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                </td>
                <td>
                  {% if contact.mobile %}
                  <a href="tel:{{ contact.mobile }}">{{ contact.mobile }}</a>
                  {% else %} 
                    {{ contact.landline|default:"-" }} 
                  {% endif %}
                </td>
                <td>{{ contact.created_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:contact_detail' contact.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:contact_update' contact.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center">
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No contacts found for this company.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <table id="company-documents-table" class="table table-striped">
            <thead>
              <tr>
                <th>Document Name</th>
                <th>Document Type</th>
                <th>Uploaded By</th>
                <th>Uploaded Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for document in documents %}
              <tr>
                <td>
                  <a
                    href="{% url 'crm:document_detail' document.pk %}"
                    class="fw-bold link-color"
                  >
                    {{ document.document_name }}
                  </a>
                </td>
                <td>{{ document.document_type }}</td>
                <td>{{ document.uploaded_by.get_full_name }}</td>
                <td>{{ document.uploaded_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:document_detail' document.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:document_update' document.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <a
                      href="{% url 'crm:document_delete' document.pk %}"
                      class="btn btn-sm btn-danger"
                      title="Delete"
                    >
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No documents found for this company.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if company.company_type == 'Client' %}
    <!-- Travel Policies Tab -->
    <div class="tab-pane fade" id="travel-policies" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <table id="company-travel-policies-table" class="table table-striped">
            <thead>
              <tr>
                <th>Policy Name</th>
                <th>Policy Type</th>
                <th>Uploaded By</th>
                <th>Uploaded Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for policy in travel_policies %}
              <tr>
                <td>
                  <a
                    href="{% url 'crm:travel_policy_detail' policy.pk %}"
                    class="fw-bold link-color"
                  >
                    {{ policy.policy_name }}
                  </a>
                </td>
                <td>{{ policy.policy_type }}</td>
                <td>{{ policy.uploaded_by.get_full_name }}</td>
                <td>{{ policy.uploaded_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:travel_policy_detail' policy.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:travel_policy_update' policy.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <a
                      href="{% url 'crm:travel_policy_delete' policy.pk %}"
                      class="btn btn-sm btn-danger"
                      title="Delete"
                    >
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No travel policies found for this company.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Activities Tab -->
    <div class="tab-pane fade" id="activities" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-12">
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0">Activity History</h5>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="activity-search"
                          placeholder="Search activities..."
                        />
                        <button
                          class="btn btn-outline-secondary"
                          type="button"
                          id="activity-search-btn"
                        >
                          <i class="fas fa-search"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          id="activity-from-date"
                          placeholder="From Date"
                        />
                        <input
                          type="date"
                          class="form-control"
                          id="activity-to-date"
                          placeholder="To Date"
                        />
                        <button
                          class="btn btn-outline-secondary"
                          type="button"
                          id="activity-clear-date-btn"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <select class="form-select" id="activity-type-filter">
                        <option value="all">All Activities</option>
                        <option value="system">System Changes</option>
                        <option value="email">Emails</option>
                        <option value="call">Calls</option>
                        <option value="note">Notes</option>
                        <option value="exception">Exceptions</option>
                      </select>
                    </div>
                  </div>
                  <div class="timeline">
                    {% for activity in activities %}
                    <div 
                      class="timeline-item border-{% if activity.activity_type == 'created' %}success{% elif activity.activity_type == 'updated' %}warning{% elif activity.activity_type == 'deleted' %}danger{% elif activity.activity_type == 'email' %}info{% elif activity.activity_type == 'call' %}primary{% elif activity.activity_type == 'note' %}warning{% elif activity.activity_type == 'exception' %}danger{% else %}info{% endif %}"
                      data-activity-type="{{ activity.activity_type }}"
                      data-activity-description="{{ activity.description }}"
                    >
                      <div class="timeline-icon">
                        {% if activity.activity_type == 'created' %}
                        <i class="fas fa-plus-circle"></i>
                        {% elif activity.activity_type == 'updated' %}
                        <i class="fas fa-exchange-alt"></i>
                        {% elif activity.activity_type == 'deleted' %}
                        <i class="fas fa-trash"></i>
                        {% elif activity.activity_type == 'email' %}
                        <i class="fas fa-envelope"></i>
                        {% elif activity.activity_type == 'call' %}
                        <i class="fas fa-phone"></i>
                        {% elif activity.activity_type == 'note' %}
                        <i class="fas fa-sticky-note"></i>
                        {% elif activity.activity_type == 'exception' %}
                        <i class="fas fa-exclamation-triangle"></i>
                        {% else %}
                        <i class="fas fa-clipboard"></i>
                        {% endif %}
                      </div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <span class="badge bg-secondary">
                            {{ activity.created_at|date:"d M Y" }}
                          </span>
                          <span class="user-icon">
                            <i class="fas fa-user"></i>
                            {{ activity.performed_by.get_full_name }}
                          </span>
                        </div>
                        <div class="timeline-body">
                          <div class="activity-card">
                            <div class="card-body">
                              <h5 class="card-title">
                                {% if activity.activity_type == 'created' %}
                                <i class="fas fa-plus-circle"></i>
                                Created 
                                {% elif activity.activity_type == 'updated' %}
                                <i class="fas fa-exchange-alt"></i>
                                Updated 
                                {% elif activity.activity_type == 'deleted' %}
                                <i class="fas fa-trash"></i>
                                Deleted 
                                {% elif activity.activity_type == 'email' %}
                                <i class="fas fa-envelope"></i>
                                Email 
                                {% elif activity.activity_type == 'call' %}
                                <i class="fas fa-phone"></i>
                                Call 
                                {% elif activity.activity_type == 'note' %}
                                <i class="fas fa-sticky-note"></i>
                                Note 
                                {% elif activity.activity_type == 'exception' %}
                                <i class="fas fa-exclamation-triangle"></i>
                                Exception 
                                {% else %}
                                <i class="fas fa-clipboard"></i>
                                {{ activity.activity_type|capfirst }} 
                                {% endif %}
                              </h5>
                              <p class="card-text">
                                {% if activity.activity_type == 'created' or activity.activity_type == 'updated' or activity.activity_type == 'deleted' %}
                                  {{ activity.description }}
                                {% elif activity.activity_type == 'email' or activity.activity_type == 'call' or activity.activity_type == 'note' or activity.activity_type == 'exception' %}
                                  <button 
                                    type="button" 
                                    class="btn btn-link p-0" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#activity-details-modal" 
                                    data-activity-type="{{ activity.activity_type }}"
                                    data-activity-description="{{ activity.description }}"
                                    data-activity-data="{{ activity.data }}">
                                    {% if activity.activity_type == 'email' %}
                                      <i class="fas fa-envelope"></i> View Email
                                    {% elif activity.activity_type == 'call' %}
                                      <i class="fas fa-phone"></i> View Call Details
                                    {% elif activity.activity_type == 'note' %}
                                      <i class="fas fa-sticky-note"></i> View Note
                                    {% elif activity.activity_type == 'exception' %}
                                      <i class="fas fa-exclamation-triangle"></i> View Exception Details
                                    {% endif %}
                                  </button>
                                {% else %}
                                  {{ activity.description }}
                                {% endif %}
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% empty %}
                    <div class="alert alert-info mb-0">
                      <i class="fas fa-info-circle me-2"></i>
                      No activities found for this company.
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Activity Details Modal -->
<div
  class="modal fade"
  id="activity-details-modal"
  tabindex="-1"
  aria-labelledby="activity-details-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activity-details-modal-label"></h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="activity-details-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<!-- DataTables and Responsive extension -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<script src="{% static 'js/company_detail.js' %}"></script>
<script src="{% static 'js/tab_handler.js' %}"></script>
<script>
  $(document).ready(function() {
    // Activity filtering
    $('#activity-search').on('keyup', function() {
      filterActivities();
    });
    
    $('#activity-type-filter').on('change', function() {
      filterActivities();
    });
    
    $('#activity-from-date, #activity-to-date').on('change', function() {
      filterActivities();
    });
    
    $('#activity-clear-date-btn').on('click', function() {
      $('#activity-from-date, #activity-to-date').val('');
      filterActivities();
    });
    
    function filterActivities() {
      const searchValue = $('#activity-search').val().toLowerCase();
      const activityType = $('#activity-type-filter').val();
      const fromDate = $('#activity-from-date').val() ? new Date($('#activity-from-date').val()) : null;
      const toDate = $('#activity-to-date').val() ? new Date($('#activity-to-date').val()) : null;
      
      $('.timeline-item').each(function() {
        const $item = $(this);
        const description = $item.data('activity-description').toLowerCase();
        const type = $item.data('activity-type');
        const dateStr = $item.find('.timeline-header .badge').text().trim();
        
        // Parse the date string (format: "DD MMM YYYY")
        const dateParts = dateStr.split(' ');
        const months = {
          'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
          'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
        };
        const day = parseInt(dateParts[0]);
        const month = months[dateParts[1]];
        const year = parseInt(dateParts[2]);
        const activityDate = new Date(year, month, day);
        
        // Apply filters
        let showBySearch = !searchValue || description.includes(searchValue);
        let showByType = activityType === 'all' || 
                         (activityType === 'system' && (type === 'created' || type === 'updated' || type === 'deleted')) ||
                         type === activityType;
        let showByDate = true;
        
        if (fromDate && toDate) {
          showByDate = activityDate >= fromDate && activityDate <= toDate;
        } else if (fromDate) {
          showByDate = activityDate >= fromDate;
        } else if (toDate) {
          showByDate = activityDate <= toDate;
        }
        
        $item.toggle(showBySearch && showByType && showByDate);
      });
      
      // Show message if no results
      if ($('.timeline-item:visible').length === 0) {
        if ($('.timeline .no-results').length === 0) {
          $('.timeline').append('<div class="alert alert-info no-results mt-3"><i class="fas fa-info-circle me-2"></i>No activities match your search criteria</div>');
        }
      } else {
        $('.timeline .no-results').remove();
      }
    }
  });

  // Activity details modal
  $('#activity-details-modal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    const activityType = button.data('activity-type');
    const description = button.data('activity-description');
    const activityData = button.data('activity-data');
    
    const modal = $(this);
    
    // Set modal title based on activity type
    let title = '';
    if (activityType === 'email') {
      title = '<i class="fas fa-envelope me-2"></i> Email Details';
    } else if (activityType === 'call') {
      title = '<i class="fas fa-phone me-2"></i> Call Details';
    } else if (activityType === 'note') {
      title = '<i class="fas fa-sticky-note me-2"></i> Note Details';
    } else if (activityType === 'exception') {
      title = '<i class="fas fa-exclamation-triangle me-2"></i> Exception Details';
    }
    
    modal.find('.modal-title').html(title);
    
    // Format activity data for display
    let contentHtml = '';
    try {
      const data = JSON.parse(activityData);
      
      if (activityType === 'email') {
        contentHtml = `
          <div class="mb-3">
            <strong>Subject:</strong> ${data.subject || 'N/A'}
          </div>
          <div class="mb-3">
            <strong>To:</strong> ${data.recipients || 'N/A'}
          </div>
          <div class="mb-3">
            <strong>Message:</strong>
            <div class="p-3 bg-light rounded">${data.message || 'No message content'}</div>
          </div>
        `;
      } else if (activityType === 'call') {
        contentHtml = `
          <div class="mb-3">
            <strong>Contact:</strong> ${data.contact || 'N/A'}
          </div>
          <div class="mb-3">
            <strong>Duration:</strong> ${data.duration || 'N/A'}
          </div>
          <div class="mb-3">
            <strong>Notes:</strong>
            <div class="p-3 bg-light rounded">${data.notes || 'No call notes'}</div>
          </div>
        `;
      } else if (activityType === 'note' || activityType === 'exception') {
        contentHtml = `
          <div class="mb-3">
            <strong>Details:</strong>
            <div class="p-3 bg-light rounded">${data.content || description || 'No details provided'}</div>
          </div>
        `;
      }
    } catch (e) {
      contentHtml = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Could not parse activity data. Showing raw description instead.
        </div>
        <div class="p-3 bg-light rounded">${description}</div>
      `;
    }
    
    modal.find('#activity-details-content').html(contentHtml);
  });
  
  // Activity form switching
  document.addEventListener("DOMContentLoaded", function () {
    const activityCards = document.querySelectorAll(".activity-type-card");
    const activityForms = document.querySelectorAll(".activity-form");

    console.log("Activity cards found:", activityCards.length);

    function showSelectedForm(activityType) {
      activityForms.forEach((form) => {
        form.classList.add("d-none");
      });

      const selectedForm = document.getElementById(`${activityType}-form`);
      if (selectedForm) {
        selectedForm.classList.remove("d-none");
      }

      activityCards.forEach((card) => {
        if (card.dataset.activityType === activityType) {
          card.classList.add("active");
        } else {
          card.classList.remove("active");
        }
      });
    }

    activityCards.forEach((card) => {
      card.style.cursor = "pointer";
      card.addEventListener("click", function () {
        const activityType = this.dataset.activityType;
        showSelectedForm(activityType);
      });
    });

    if (activityCards.length > 0) {
      const defaultActivityType = activityCards[0].dataset.activityType;
      showSelectedForm(defaultActivityType);
    }

    $("#logActivityModal").on("shown.bs.modal", function () {
      const emailCard = document.querySelector('.activity-type-card[data-activity-type="email"]');
      if (emailCard) {
        emailCard.click();
      }
    });
  });
</script>
{% endblock extra_js %}

{% include 'crm/includes/invoice_remarks_modal.html' %}
{% block postload_js %}{% endblock postload_js %}
