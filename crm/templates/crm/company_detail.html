{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/company_detail.css' %}">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- Company Profile Header -->
<div class="profile-header bg-gradient-blue-purple-left text-white py-4 mb-4">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">{{ company.company_name }}</h1>
                <p class="mb-0">
                    <i class="fas fa-building me-2"></i>{{ company.industry }}
                    <span class="mx-2">|</span>
                    <i class="fas fa-map-marker-alt me-2"></i>{{ company.city }}, {{ company.country }}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="{% url 'crm:company_list' %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
                <a href="{% url 'crm:company_update' company.pk %}" class="btn btn-light me-2">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <a href="{% url 'crm:contact_create' company_id=company.pk %}" class="btn btn-light">
                    <i class="fas fa-user-plus"></i> Add Contact
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mb-5">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="companyTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">
                <i class="fas fa-info-circle me-2"></i>Overview
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="contacts-tab" data-bs-toggle="tab" href="#contacts" role="tab">
                <i class="fas fa-users me-2"></i>Contacts
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="activities-tab" data-bs-toggle="tab" href="#activities" role="tab">
                <i class="fas fa-chart-line me-2"></i>Activities
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents" role="tab">
                <i class="fas fa-file-alt me-2"></i>Documents
            </a>
        </li>
        {% if company.company_type == 'Client' %}
        <li class="nav-item">
            <a class="nav-link" id="travel-policies-tab" data-bs-toggle="tab" href="#travel-policies" role="tab">
                <i class="fas fa-plane me-2"></i>Travel Policies
            </a>
        </li>
        {% endif %}
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="companyTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-4">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Basic Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-sm-5 text-muted">Company Type</div>
                                <div class="col-sm-7">{{ company.company_type }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-5 text-muted">Industry</div>
                                <div class="col-sm-7">{{ company.industry }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-5 text-muted">Email</div>
                                <div class="col-sm-7">
                                    <a href="mailto:{{ company.email }}">{{ company.email }}</a>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-5 text-muted">Phone</div>
                                <div class="col-sm-7">
                                    <a href="tel:{{ company.phone_number }}">{{ company.phone_number }}</a>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-5 text-muted">LinkedIn</div>
                                <div class="col-sm-7">
                                    {% if company.linkedin_social_page %}
                                    <a href="{{ company.linkedin_social_page }}" target="_blank">
                                        <i class="fab fa-linkedin"></i> View Profile
                                    </a>
                                    {% else %}
                                    <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Address Information</h5>
                        </div>
                        <div class="card-body">
                            <address class="mb-0">
                                {{ company.street_address }}<br>
                                {{ company.city }}, {{ company.state_province }} {{ company.postal_code }}<br>
                                {{ company.country }}
                            </address>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Description</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ company.description|default:"No description provided." }}</p>
                        </div>
                    </div>
                    
                    <!-- Linked Companies -->
                    {% if company.company_type == 'Client' or company.company_type == 'Supplier' %}
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Linked Companies</h5>
                            <a href="{% url 'crm:manage_company_relationships' company.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-link"></i> Manage
                            </a>
                        </div>
                        <div class="card-body">
                            {% with from_relationships=company.from_relationships.filter to_relationships=company.to_relationships.filter %}
                                {% if from_relationships.exists or to_relationships.exists %}
                                    <div class="list-group list-group-flush">
                                        {% for rel in from_relationships %}
                                            {% if rel.is_active %}
                                            <div class="list-group-item px-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <a href="{% url 'crm:company_detail' rel.to_company.id %}">
                                                            {{ rel.to_company.company_name }}
                                                        </a>
                                                        <span class="badge bg-info ms-2">{{ rel.get_relationship_type_display }}</span>
                                                    </div>
                                                    <span class="badge bg-secondary">Outgoing</span>
                                                </div>
                                                {% if rel.description %}
                                                <small class="text-muted">{{ rel.description }}</small>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% for rel in to_relationships %}
                                            {% if rel.is_active %}
                                            <div class="list-group-item px-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <a href="{% url 'crm:company_detail' rel.from_company.id %}">
                                                            {{ rel.from_company.company_name }}
                                                        </a>
                                                        <span class="badge bg-info ms-2">{{ rel.get_relationship_type_display }}</span>
                                                    </div>
                                                    <span class="badge bg-secondary">Incoming</span>
                                                </div>
                                                {% if rel.description %}
                                                <small class="text-muted">{{ rel.description }}</small>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted">No linked companies found. Use the "Manage" button to link this company to others.</p>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column - Client/Supplier Profile -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header text-white card-header-primary">
                            <h5 class="mb-0">{% if company.company_type == 'Client' %}Client{% else %}Supplier{% endif %} Profile</h5>
                        </div>
                        <div class="card-body">
                            <!-- Basic Information -->
                            <div class="profile-section mb-4">
                                <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">{% if company.company_type == 'Client' %}Client{% else %}Supplier{% endif %} Type</label>
                                            <span class="fs-6">{% if company.company_type == 'Client' %}{{ company.client_profile.client_type }}{% else %}{{ company.supplier_profile.supplier_type }}{% endif %}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Status</label>
                                            <span class="badge bg-primary">{% if company.company_type == 'Client' %}{{ company.client_profile.client_status }}{% else %}{{ company.supplier_profile.supplier_status }}{% endif %}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">{% if company.company_type == 'Client' %}Operations Team{% else %}Department{% endif %}</label>
                                            <span class="fs-6">{% if company.company_type == 'Client' %}{{ company.client_profile.client_ops_team|default:"Not assigned" }}{% else %}{{ company.supplier_profile.supplier_for_department }}{% endif %}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">{% if company.company_type == 'Client' %}Account Manager{% else %}Owner{% endif %}</label>
                                            <span class="fs-6">
                                                {% if company.company_type == 'Client' %}
                                                    {% if company.client_profile.client_account_manager %}
                                                        {{ company.client_profile.client_account_manager.get_full_name }}
                                                    {% else %}
                                                        Not assigned
                                                    {% endif %}
                                                {% else %}
                                                    {% if company.supplier_profile.supplier_owner %}
                                                        {{ company.supplier_profile.supplier_owner.get_full_name }}
                                                    {% else %}
                                                        Not assigned
                                                    {% endif %}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Finance/Invoice Information -->
                            <div class="profile-section mb-4">
                                <h6 class="border-bottom pb-2 mb-3">Finance/Invoice Information</h6>
                                <div class="row">
                                    {% if company.company_type == 'Client' %}
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Sage Name</label>
                                            <span class="fs-6">{{ company.client_profile.sage_name|default:"Not set" }}</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Midoco CRM Number</label>
                                            <span class="fs-6">{{ company.client_profile.midoco_crm_number|default:"Not set" }}</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Invoice References</label>
                                            {% if company.client_profile.invoice_reference_options.exists %}
                                            <div class="mt-2">
                                                {% for reference in company.client_profile.invoice_reference_options.all %}
                                                <div class="badge bg-primary me-1 mb-1">
                                                    {{ reference.name }}
                                                    {% with client_refs=reference.clientinvoicereference_set.all %}
                                                        {% for client_ref in client_refs %}
                                                            {% if client_ref.client_profile == company.client_profile %}
                                                                <span class="badge {% if client_ref.is_mandatory %}bg-danger{% else %}bg-secondary{% endif %} ms-1">
                                                                    {% if client_ref.is_mandatory %}Mandatory{% else %}Optional{% endif %}
                                                                </span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endwith %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted">No references set</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="col-md-{% if company.company_type == 'Client' %}6{% else %}4{% endif %}">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Invoicing Type</label>
                                            <span class="fs-6">{% if company.company_type == 'Client' %}{{ company.client_profile.invoicing_type|default:"Not set" }}{% else %}{{ company.supplier_profile.invoicing_type|default:"Not set" }}{% endif %}</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Invoicing Frequency</label>
                                            <span class="fs-6">{% if company.company_type == 'Client' %}{{ company.client_profile.invoicing_frequency|default:"Not set" }}{% else %}{{ company.supplier_profile.invoicing_frequency|default:"Not set" }}{% endif %}</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Payment Terms</label>
                                            <span class="fs-6">{% if company.company_type == 'Client' %}{{ company.client_profile.payment_terms|default:"Not set" }}{% else %}{{ company.supplier_profile.payment_terms|default:"Not set" }}{% endif %}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if company.company_type == 'Client' %}
                            <!-- Corporate Benefits -->
                            <div class="profile-section mb-4">
                                <h6 class="border-bottom pb-2 mb-3">Corporate Benefits</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Hotel Rates</label>
                                            <span class="fs-6">{{ company.client_profile.corporate_hotel_rates|default:"Not set" }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Airline Fares</label>
                                            <span class="fs-6">{{ company.client_profile.corporate_airline_fares|default:"Not set" }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="text-muted d-block">Memberships</label>
                                            <span class="fs-6">{{ company.client_profile.company_memberships|default:"Not set" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Service Status -->
                            <div class="profile-section">
                                <h6 class="border-bottom pb-2 mb-3">Service Status</h6>
                                <div class="row">
                                    {% if company.company_type == 'Client' %}
                                    <div class="col-md-6">
                                        <ul class="list-unstyled status-list">
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.has_new_contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>New Contract Signed</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.signed_up_corporate_schemes %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Corporate Schemes</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.signed_up_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Travelogix</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.meetings_events_requirements %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Meetings & Events Requirements</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.reporting_standard_bespoke %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Standard/Bespoke Reporting</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.access_to_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Access to Travelogix</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.travel_policy_health_check_offered %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Travel Policy Health Check Offered</span>
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.testimonial_requested %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Testimonial Requested</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="border-bottom pb-2 mb-3">Sustainability Information</h6>
                                        <ul class="list-unstyled status-list">
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.communicated_esg_support %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>ESG Support Communicated</span>
                                            </li>
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.receive_co2_reporting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>CO2 Reporting</span>
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <i class="fas {% if company.client_profile.discussed_offsetting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Offsetting Discussed</span>
                                            </li>
                                        </ul>
                                    </div>
                                    {% else %}
                                    <div class="col-12">
                                        <ul class="list-unstyled status-list">
                                            <li class="mb-2 d-flex align-items-center">
                                                <i class="fas {% if company.supplier_profile.new_supplier_form_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>New Supplier Form Signed</span>
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <i class="fas {% if company.supplier_profile.contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                                                <span>Contract Signed</span>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div class="tab-pane fade" id="contacts" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <table id="company-contacts-table" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Job Role</th>
                                <th>Tags</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in contacts %}
                            <tr>
                                <td>
                                    <a href="{% url 'crm:contact_detail' contact.pk %}" class="fw-bold link-color">
                                        {{ contact.first_name }} {{ contact.last_name }}
                                    </a>
                                </td>
                                <td>{{ contact.job_role }}</td>
                                <td>
                                    {% for tag in contact.tag_list %}
                                        <span class="badge me-1 {% if tag == 'primary' %}bg-primary
                                            {% elif tag == 'key_personnel' %}bg-success
                                            {% elif tag == 'booker' %}bg-warning text-dark
                                            {% elif tag == 'vip_traveller' %}bg-warning
                                            {% elif tag == 'traveller' %}bg-info
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {% if tag == 'primary' %}Primary Contact
                                            {% elif tag == 'key_personnel' %}Key Personnel
                                            {% elif tag == 'booker' %}Booker
                                            {% elif tag == 'vip_traveller' %}VIP Traveller
                                            {% elif tag == 'traveller' %}Traveller
                                            {% else %}{{ tag }}
                                            {% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                                </td>
                                <td>
                                    {% if contact.mobile %}
                                    <a href="tel:{{ contact.mobile }}">{{ contact.mobile }}</a>
                                    {% else %}
                                    {{ contact.landline|default:"-" }}
                                    {% endif %}
                                </td>
                                <td>{{ contact.created_at|date:"d M Y" }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'crm:contact_detail' contact.pk %}" class="btn btn-sm action-btn-purple text-white" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'crm:contact_update' contact.pk %}" class="btn btn-sm btn-secondary-ea" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No contacts found for this company.
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for activity in activities %}
                        <div class="timeline-item">
                            <h6 class="mb-1">{{ activity.title }}</h6>
                            <p class="text-muted small mb-2">
                                {{ activity.performed_at|date:"d M Y, H:i" }} by {{ activity.performed_by.get_full_name }}
                            </p>
                            <p class="mb-0">{{ activity.description }}</p>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>No activities recorded yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div class="tab-pane fade" id="documents" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    {% if user.role == 'superuser' or user.role == 'admin' or user.role == 'marketing' %}
                    <div class="d-flex justify-content-end mb-3">
                        <a href="{% url 'crm:document_upload' company.id %}" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Upload Document
                        </a>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Type</th>
                                    <th>Upload Date</th>
                                    <th>Expiry Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in documents %}
                                    {% if user.role == 'agent' and document.document_type == 'contract' or user.role == 'agent' and document.document_type == 'agreement' %}
                                        <!-- Skip contracts and agreements for agents -->
                                    {% else %}
                                    <tr>
                                        <td>{{ document.title }}</td>
                                        <td>{{ document.document_type }}</td>
                                        <td>{{ document.uploaded_at|date:"d M Y" }}</td>
                                        <td>
                                            {% if document.expiry_date %}
                                            <span class="{% if document.is_expired %}text-danger{% endif %}">
                                                {{ document.expiry_date|date:"d M Y" }}
                                            </span>
                                            {% else %}
                                            <span class="text-muted">No expiry</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ document.file.url }}" class="btn btn-sm btn-primary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                {% if user.role == 'superuser' or user.role == 'admin' or user.role == 'marketing' %}
                                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteDocumentModal{{ document.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                
                                                <!-- Delete Confirmation Modal -->
                                                <div class="modal fade" id="deleteDocumentModal{{ document.id }}" tabindex="-1" aria-labelledby="deleteDocumentModalLabel{{ document.id }}" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="deleteDocumentModalLabel{{ document.id }}">Confirm Document Deletion</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <p>Are you sure you want to delete the document "<strong>{{ document.title }}</strong>"?</p>
                                                                <p class="text-danger">This action cannot be undone.</p>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                <form method="POST" action="{% url 'crm:document_delete' document.id %}" style="display: inline;">
                                                                    {% csrf_token %}
                                                                    <button type="submit" class="btn btn-danger">Delete Document</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                                        <p>No documents uploaded yet.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Travel Policies Tab (Only for Clients) -->
        {% if company.company_type == 'Client' %}
        <div class="tab-pane fade" id="travel-policies" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-3">
                        <a href="{% url 'crm:travel_policy_create' company_id=company.pk %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Create Travel Policy
                        </a>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="travel-policies-table">
                            <thead>
                                <tr>
                                    <th>Policy Name</th>
                                    <th>Effective Date</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for policy in company.travel_policies.all %}
                                <tr>
                                    <td>{{ policy.policy_name }}</td>
                                    <td>{{ policy.effective_date|date:"d M Y" }}</td>
                                    <td>
                                        <span class="badge {% if policy.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {% if policy.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ policy.last_updated|date:"d M Y, H:i" }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'crm:travel_policy_detail' policy.id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            <a href="{% url 'crm:travel_policy_update' policy.id %}" class="btn btn-sm btn-warning">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deletePolicyModal{{ policy.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            
                                            <!-- Delete Confirmation Modal -->
                                            <div class="modal fade" id="deletePolicyModal{{ policy.id }}" tabindex="-1" aria-labelledby="deletePolicyModalLabel{{ policy.id }}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="deletePolicyModalLabel{{ policy.id }}">Confirm Policy Deletion</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p>Are you sure you want to delete the travel policy "<strong>{{ policy.policy_name }}</strong>"?</p>
                                                            <p class="text-danger">This action cannot be undone.</p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <form method="POST" action="{% url 'crm:travel_policy_delete' policy.id %}" style="display: inline;">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-danger">Delete Policy</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-plane fa-3x mb-3"></i>
                                        <p>No travel policies defined yet. Click the "Create Travel Policy" button to add one.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/company_detail.js' %}"></script>
<script src="{% static 'js/tab_handler.js' %}"></script>
{% endblock %}

{% include 'crm/includes/invoice_remarks_modal.html' %} 

{% block postload_js %}{% endblock %} 