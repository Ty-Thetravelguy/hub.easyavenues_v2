{% extends 'base.html' %}
{% load static %}
{% load crm_tags %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/activity_tabs.css' %}" />
<link rel="stylesheet" href="{% static 'css/company_detail.css' %}" />
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css"
/>
{% endblock %}

{% block content %}
<!-- Company Profile Header -->
<div class="profile-header bg-gradient-blue-purple-left text-white py-4 mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2">{{ company.company_name }}</h1>
        <p class="mb-0">
          <i class="fas fa-building me-2"></i>
          {{ company.industry }}
          <span class="mx-2">|</span>
          <i class="fas fa-map-marker-alt me-2"></i>
          {{ company.city }}, {{ company.country }}
        </p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="{% url 'crm:company_list' %}" class="btn btn-light me-2">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
        <a href="{% url 'crm:company_update' company.pk %}" class="btn btn-light me-2">
          <i class="fas fa-edit"></i>
          Edit
        </a>
        <a href="{% url 'crm:contact_create' company_id=company.pk %}" class="btn btn-light">
          <i class="fas fa-user-plus"></i>
          Add Contact
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mb-5">
  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-4" id="companyTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">
        <i class="fas fa-info-circle me-2"></i>
        Overview
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="contacts-tab" data-bs-toggle="tab" href="#contacts" role="tab">
        <i class="fas fa-users me-2"></i>
        Contacts
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents" role="tab">
        <i class="fas fa-file-alt me-2"></i>
        Documents
      </a>
    </li>
    {% if company.company_type == 'Client' %}
    <li class="nav-item">
      <a
        class="nav-link"
        id="travel-policies-tab"
        data-bs-toggle="tab"
        href="#travel-policies"
        role="tab"
      >
        <i class="fas fa-plane me-2"></i>
        Travel Policies
      </a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link" id="activities-tab" data-bs-toggle="tab" href="#activities" role="tab">
        <i class="fas fa-chart-line me-2"></i>
        Activities
      </a>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="companyTabsContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-4">
          <!-- Basic Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Company Type</div>
                <div class="col-sm-7">{{ company.company_type }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Industry</div>
                <div class="col-sm-7">{{ company.industry }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Email</div>
                <div class="col-sm-7">
                  <a href="mailto:{{ company.email }}">{{ company.email }}</a>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Phone</div>
                <div class="col-sm-7">
                  <a href="tel:{{ company.phone_number }}">{{ company.phone_number }}</a>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-5 text-muted">LinkedIn</div>
                <div class="col-sm-7">
                  {% if company.linkedin_social_page %}
                  <a href="{{ company.linkedin_social_page }}" target="_blank">
                    <i class="fab fa-linkedin"></i>
                    View Profile
                  </a>
                  {% else %}
                  <span class="text-muted">Not provided</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Address Information</h5>
            </div>
            <div class="card-body">
              <address class="mb-0">
                {{ company.street_address }}
                <br />
                {{ company.city }}, {{ company.state_province }} {{ company.postal_code }}
                <br />
                {{ company.country }}
              </address>
            </div>
          </div>

          <!-- Description -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Description</h5>
            </div>
            <div class="card-body">
              <p class="mb-0">{{ company.description|default:"No description provided." }}</p>
            </div>
          </div>

          {% if company.company_type == 'Client' or company.company_type == 'Supplier' %}
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Linked Companies</h5>
              <a
                href="{% url 'crm:manage_company_relationships' company.id %}"
                class="btn btn-primary btn-sm"
              >
                <i class="fas fa-link"></i>
                Manage
              </a>
            </div>
            <div class="card-body">
              {% if company.from_relationships.exists or company.to_relationships.exists %}
              <div class="list-group list-group-flush">
                {% for rel in company.from_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.to_company.id %}">
                          {{ rel.to_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Outgoing</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
                
                {% for rel in company.to_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.from_company.id %}">
                          {{ rel.from_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Incoming</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted">
                No linked companies found. Use the "Manage" button to link this company to others.
              </p>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header text-white card-header-primary">
              <h5 class="mb-0">
                {% if company.company_type == 'Client' %}
                Client
                {% else %}
                Supplier
                {% endif %}
                Profile
              </h5>
            </div>
            <div class="card-body">
              <!-- Basic Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                <div class="row">
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}Client{% else %}Supplier{% endif %}
                        Type
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_type }}
                        {% else %}
                          {{ company.supplier_profile.supplier_type }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">Status</label>
                      <span class="badge bg-primary">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_status }}
                        {% else %}
                          {{ company.supplier_profile.supplier_status }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Operations Team
                        {% else %}
                          Department
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_ops_team|default:"Not assigned" }}
                        {% else %}
                          {{ company.supplier_profile.supplier_for_department }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Account Manager
                        {% else %}
                          Owner
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {% if company.client_profile.client_account_manager %}
                            {{ company.client_profile.client_account_manager.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% else %}
                          {% if company.supplier_profile.supplier_owner %}
                            {{ company.supplier_profile.supplier_owner.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Finance/Invoice Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Finance/Invoice Information</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="text-muted d-block">Sage Name</label>
                      <span class="fs-6">
                        {{ company.client_profile.sage_name|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Midoco CRM Number</label>
                      <span class="fs-6">
                        {{ company.client_profile.midoco_crm_number|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoice References</label>
                      {% if company.client_profile.invoice_reference_options.exists %}
                      <div class="mt-2">
                        {% for reference in company.client_profile.invoice_reference_options.all %}
                        <div class="badge bg-primary me-1 mb-1">
                          {{ reference.name }}
                          {% for client_ref in reference.clientinvoicereference_set.all %}
                            {% if client_ref.client_profile == company.client_profile %}
                            <span class="badge {% if client_ref.is_mandatory %}bg-danger{% else %}bg-secondary{% endif %} ms-1">
                              {% if client_ref.is_mandatory %}Mandatory{% else %}Optional{% endif %}
                            </span>
                            {% endif %}
                          {% endfor %}
                        </div>
                        {% endfor %}
                        
                        {% if not company.client_profile.invoice_reference_options.all %}
                          <span class="text-muted">No references set</span>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                  
                  <div class="col-md-{% if company.company_type == 'Client' %}6{% else %}12{% endif %}">
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Type</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_type|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_type|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Frequency</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_frequency|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_frequency|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Payment Terms</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.payment_terms|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.payment_terms|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {% if company.company_type == 'Client' %}
              <!-- Corporate Benefits -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Corporate Benefits</h6>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Hotel Rates</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_hotel_rates|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Airline Fares</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_airline_fares|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Memberships</label>
                      <span class="fs-6">
                        {{ company.client_profile.company_memberships|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Service Status -->
              <div class="profile-section">
                <h6 class="border-bottom pb-2 mb-3">Service Status</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.has_new_contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Contract Signed</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_corporate_schemes %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Corporate Schemes</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.meetings_events_requirements %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Meetings & Events Requirements</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.reporting_standard_bespoke %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Standard/Bespoke Reporting</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.access_to_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Access to Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.travel_policy_health_check_offered %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travel Policy Health Check Offered</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.testimonial_requested %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Testimonial Requested</span>
                      </li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="border-bottom pb-2 mb-3">Sustainability Information</h6>
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.communicated_esg_support %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>ESG Support Communicated</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.receive_co2_reporting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>CO2 Reporting</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.discussed_offsetting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Offsetting Discussed</span>
                      </li>
                    </ul>
                  </div>
                  {% else %}
                  <div class="col-12">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.new_supplier_form_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Supplier Form Signed</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Contract Signed</span>
                      </li>
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <table id="company-contacts-table" class="table table-striped">
            <thead>
              <tr>
                <th>Name</th>
                <th>Job Role</th>
                <th>Tags</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for contact in contacts %}
              <tr>
                <td>
                  <a href="{% url 'crm:contact_detail' contact.pk %}" class="fw-bold link-color">
                    {{ contact.first_name }} {{ contact.last_name }}
                  </a>
                </td>
                <td>{{ contact.job_role }}</td>
                <td>
                  {% for tag in contact.tag_list %}
                  <span
                    class="badge me-1 {% if tag == 'primary' %}bg-primary{% elif tag == 'key_personnel' %}bg-success{% elif tag == 'booker' %}bg-warning text-dark{% elif tag == 'vip_traveller' %}bg-warning{% elif tag == 'traveller' %}bg-info{% else %}bg-secondary{% endif %}"
                  >
                    {% if tag == 'primary' %} 
                      Primary Contact 
                    {% elif tag == 'key_personnel' %}
                      Key Personnel 
                    {% elif tag == 'booker' %} 
                      Booker 
                    {% elif tag == 'vip_traveller' %}
                      VIP Traveller 
                    {% elif tag == 'traveller' %} 
                      Traveller 
                    {% else %} 
                      {{ tag }}
                    {% endif %}
                  </span>
                  {% endfor %}
                </td>
                <td>
                  <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                </td>
                <td>
                  {% if contact.mobile %}
                  <a href="tel:{{ contact.mobile }}">{{ contact.mobile }}</a>
                  {% else %} 
                    {{ contact.landline|default:"-" }} 
                  {% endif %}
                </td>
                <td>{{ contact.created_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:contact_detail' contact.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:contact_update' contact.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center">
                  <p class="mb-0 py-3 text-muted">
                    <i class="fas fa-user me-2"></i>
                    There are no contacts available.
                  </p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Documents</h5>
          <a href="{% url 'crm:document_upload' company.id %}" class="btn btn-primary">
            <i class="fas fa-upload me-2"></i>Upload Document
          </a>
        </div>
        <div class="card-body">
          <!-- Document search and display controls -->
          <div class="row mb-3">
            <div class="col-md-6 d-flex align-items-center">
              <div class="me-2">Show</div>
              <select class="form-select form-select-sm w-auto me-2" id="documents-per-page">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <div>documents per page</div>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <input type="text" class="form-control" id="document-search" placeholder="Search documents...">
                <button class="btn btn-outline-secondary" type="button">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Standard HTML table -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Document Name</th>
                  <th>Document Type</th>
                  <th>Uploaded By</th>
                  <th>Uploaded Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for document in documents %}
                <tr>
                  <td>
                    <a href="{% url 'crm:document_detail' document.pk %}" class="fw-bold link-color">
                      {{ document.title }}
                    </a>
                  </td>
                  <td>{{ document.get_document_type_display }}</td>
                  <td>{{ document.uploaded_by.get_full_name }}</td>
                  <td>{{ document.uploaded_at|date:"d M Y" }}</td>
                  <td>
                    <div class="d-flex gap-2">
                      <a href="{% url 'crm:document_detail' document.pk %}" class="btn btn-sm action-btn-purple text-white" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'crm:document_update' document.pk %}" class="btn btn-sm btn-secondary-ea" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <form action="{% url 'crm:document_delete' document.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this document?');">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center">
                    <p class="mb-0 py-3 text-muted">
                      <i class="fas fa-file-alt me-2"></i>
                      There are no documents available.
                    </p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination controls if needed -->
          {% if documents %}
          <div class="row mt-3">
            <div class="col-md-6">
              <p class="text-muted mb-0">Showing 1 to {{ documents|length }} of {{ documents|length }} documents</p>
            </div>
            <div class="col-md-6">
              <nav aria-label="Document pagination" class="float-end">
                <ul class="pagination mb-0">
                  <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                  </li>
                  <li class="page-item active"><a class="page-link" href="#">1</a></li>
                  <li class="page-item disabled">
                    <a class="page-link" href="#">Next</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if company.company_type == 'Client' %}
    <!-- Travel Policies Tab -->
    <div class="tab-pane fade" id="travel-policies" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Travel Policies</h5>
          <a href="{% url 'crm:travel_policy_create' company.id %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Policy
          </a>
        </div>
        <div class="card-body">
          <!-- Controls row -->
          <div class="row mb-3">
            <div class="col-md-6 d-flex align-items-center">
              <div class="me-2">Show</div>
              <select class="form-select form-select-sm w-auto">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <div>policies per page</div>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Search policies...">
              </div>
            </div>
          </div>

          <!-- Custom table without DataTables -->
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
                <tr class="bg-light">
                  <th class="w-25">Policy Name</th>
                  <th class="w-20">Effective Date</th>
                  <th class="w-15 text-center">Status</th>
                  <th class="w-20">Last Updated</th>
                  <th class="w-20 text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for policy in travel_policies %}
                <tr>
                  <td>
                    <a href="{% url 'crm:travel_policy_detail' policy.pk %}" class="fw-bold link-color">
                      {{ policy.policy_name }}
                    </a>
                  </td>
                  <td>{{ policy.effective_date|date:"d M Y" }}</td>
                  <td class="text-center">
                    <span class="badge {% if policy.is_active %}bg-success{% else %}bg-danger{% endif %}">
                      {% if policy.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </td>
                  <td>{{ policy.last_updated|date:"d M Y" }}</td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">
                      <a href="{% url 'crm:travel_policy_detail' policy.pk %}" class="btn btn-sm action-btn-purple text-white" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'crm:travel_policy_update' policy.pk %}" class="btn btn-sm btn-secondary-ea" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <a href="{% url 'crm:travel_policy_delete' policy.pk %}" class="btn btn-sm btn-danger" title="Delete">
                        <i class="fas fa-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center">
                    <p class="mb-0 py-3 text-muted">
                      <i class="fas fa-plane-departure me-2"></i>
                      There are no travel policies available.
                    </p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="row mt-3">
            <div class="col-md-6">
              <p class="text-muted mb-0">Showing 1 to {{ travel_policies|length }} of {{ travel_policies|length }} policies</p>
            </div>
            <div class="col-md-6">
              <nav aria-label="Travel policies pagination" class="float-end">
                <ul class="pagination mb-0">
                  <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                  </li>
                  <li class="page-item active"><a class="page-link" href="#">1</a></li>
                  <li class="page-item disabled">
                    <a class="page-link" href="#">Next</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Activities Tab -->
    <div class="tab-pane fade" id="activities" role="tabpanel">
        <div class="card">
            <div class="card-body p-0">
                <input type="hidden" id="company_id" value="{{ company.id }}">
                {% include 'crm/includes/activity_tabs.html' %}
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activity-details-modal" tabindex="-1" aria-labelledby="activity-details-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activity-details-modal-label">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activity-details-container">
                <!-- Default message when no activity is selected -->
                <div id="no-activity-selected">
                    <p class="text-center text-muted">Select an activity to view details.</p>
                </div>
                
                <!-- Activity detail sections will be generated here -->
                {% for activity in activities %}
                {% if not activity.is_system_activity and activity.activity_type != 'document' %}
                <div id="activity-{{ activity.id }}-details" class="activity-detail-section" style="display: none;">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ activity.get_activity_type_display }} Activity</h6>
                            <span class="badge bg-{% if activity.activity_type == 'email' %}info{% elif activity.activity_type == 'call' %}primary{% elif activity.activity_type == 'meeting' %}success{% elif activity.activity_type == 'note' %}warning{% else %}secondary{% endif %}">{{ activity.get_activity_type_display }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            {% if activity.activity_type == 'email' %}
                                <!-- Email activity specific fields -->
                                {% with email=activity|get_activity_details:'emailactivity' %}
                                    {% if email %}
                                        <!-- Date and Time -->
                                        <dt class="col-sm-3">Email Date/Time</dt>
                                        <dd class="col-sm-9">{{ email.email_date|date:"d M Y" }} at {{ email.email_time|time:"H:i" }}</dd>
                                        
                                        <!-- Subject -->
                                        {% if email.subject %}
                                        <dt class="col-sm-3">Subject</dt>
                                        <dd class="col-sm-9">{{ email.subject }}</dd>
                                        {% endif %}
                                        
                                        <!-- Recipients -->
                                        <dt class="col-sm-3">Recipients</dt>
                                        <dd class="col-sm-9">
                                            <ul class="list-unstyled mb-0">
                                                {% for recipient in email.contact_recipients.all %}
                                                    <li>{{ recipient.first_name }} {{ recipient.last_name }} {% if recipient.email %}({{ recipient.email }}){% endif %}</li>
                                                {% endfor %}
                                                {% for recipient in email.user_recipients.all %}
                                                    <li>{{ recipient.get_full_name }} ({{ recipient.email }})</li>
                                                {% endfor %}
                                                {% if not email.contact_recipients.exists and not email.user_recipients.exists %}
                                                    <li class="text-muted">No recipients specified</li>
                                                {% endif %}
                                            </ul>
                                        </dd>
                                        
                                        <!-- Email Outcome -->
                                        {% if email.email_outcome %}
                                        <dt class="col-sm-3">Outcome</dt>
                                        <dd class="col-sm-9">
                                            <span class="badge bg-{% if email.email_outcome == 'Sent' %}success{% elif email.email_outcome == 'Received' %}info{% else %}warning{% endif %}">
                                                {{ email.email_outcome }}
                                            </span>
                                        </dd>
                                        {% endif %}
                                        
                                        <!-- Email Body -->
                                        {% if email.body %}
                                        <dt class="col-sm-3">Email Body</dt>
                                        <dd class="col-sm-9">
                                            <div class="border p-3 bg-light rounded">
                                                {{ email.body|linebreaks }}
                                            </div>
                                        </dd>
                                        {% endif %}
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </dl>
                        
                        <!-- Related tasks (keep as is) -->
                        {% if activity.todos.exists %}
                        <div class="card mt-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Related Tasks</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-group">
                                    {% for todo in activity.todos.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <span class="badge bg-{% if todo.status == 'completed' %}success{% elif todo.status == 'in_progress' %}warning{% else %}info{% endif %} me-2">
                                                {{ todo.get_status_display }}
                                            </span>
                                            {{ todo.title }}
                                        </span>
                                        <small class="text-muted">Due: {{ todo.due_date|date:"d M Y" }}</small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Moved timestamp to the bottom and made it less prominent -->
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <div class="activity-meta">
                                <small class="text-muted d-block">Added on: {{ activity.performed_at|date:"d M Y H:i" }}</small>
                                <small class="text-muted d-block">By: {{ activity.performed_by.get_full_name }}</small>
                            </div>
                            
                            <div>
                                <a href="{% url 'crm:edit_activity' activity.id %}" class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a href="{% url 'crm:delete_activity' activity.id %}" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Activity Modal -->
<div
  class="modal fade"
  id="edit-activity-modal"
  tabindex="-1"
  aria-labelledby="edit-activity-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edit-activity-modal-label">Edit Activity</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="edit-activity-form-container">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading edit form...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

<!-- Activity Side Panel -->
{% include 'crm/includes/activity_side_panel.html' %}

{% block extra_js %}
{{ block.super }}
<!-- DataTables and Responsive extension -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<!-- Select2 plugin -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Activity details JavaScript -->
<script src="{% static 'js/activity_details.js' %}"></script>
<!-- Company detail JavaScript -->
<script src="{% static 'js/company_detail.js' %}"></script>
{% endblock extra_js %}

{% include 'crm/includes/invoice_remarks_modal.html' %}
