{% extends 'base.html' %}
{% load static %}
{% load crm_tags %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/company_detail.css' %}" />
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css"
/>
<style>
  /* Simple hover effect for activity type cards */
  .activity-type-card {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    margin-bottom: 0;
    border: 1px solid #dee2e6;
    transform: translateY(0);
  }
  .activity-type-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    background-color: #f8f9fa;
  }
  .activity-type-card.active {
    border: 2px solid #4e73df;
    background-color: #eef2ff;
  }

  /* Activity Timeline Styling */
  .timeline {
    position: relative;
  }
  
  .timeline-item {
    position: relative;
    padding: 1rem;
    background-color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    margin-bottom: 1.5rem;
    border-left-width: 4px !important;
    border-left-style: solid;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 1.5rem;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fff;
    border: 2px solid;
  }
  
  .timeline-item.border-success::before {
    border-color: #198754;
  }
  
  .timeline-item.border-warning::before {
    border-color: #ffc107;
  }
  
  .timeline-item.border-danger::before {
    border-color: #dc3545;
  }
  
  .timeline-item.border-info::before {
    border-color: #0dcaf0;
  }
  
  .timeline-item.border-primary::before {
    border-color: #0d6efd;
  }
  
  /* Border colors */
  .timeline-item.border-success {
    border-left-color: #198754;
  }
  
  .timeline-item.border-warning {
    border-left-color: #ffc107;
  }
  
  .timeline-item.border-danger {
    border-left-color: #dc3545;
  }
  
  .timeline-item.border-info {
    border-left-color: #0dcaf0;
  }
  
  .timeline-item.border-primary {
    border-left-color: #0d6efd;
  }
  
  /* White-space preserving for activity descriptions */
  .timeline-item p.mb-0 {
    white-space: pre-line;
  }
  
  /* Activity Content Card Styling */
  .activity-card {
    transition: all 0.2s ease;
    border-width: 1px;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .activity-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .activity-card .card-body {
    padding: 0.75rem 1rem;
  }
  
  /* Type-specific styling */
  .activity-card.bg-primary.bg-opacity-10 {
    border-color: rgba(13, 110, 253, 0.3);
  }
  
  .activity-card.bg-success.bg-opacity-10 {
    border-color: rgba(25, 135, 84, 0.3);
  }
  
  .activity-card.bg-warning.bg-opacity-10 {
    border-color: rgba(255, 193, 7, 0.3);
  }
  
  .activity-card.bg-danger.bg-opacity-10 {
    border-color: rgba(220, 53, 69, 0.3);
  }
  
  /* Content preview */
  .content-preview {
    color: #495057;
    font-size: 0.85rem;
    line-height: 1.3;
    margin-bottom: 0;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Timeline styling */
  .timeline-icon {
    position: absolute;
    left: -40px;
    top: 20px;
    width: 30px;
    height: 30px;
    background-color: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #dee2e6;
  }
  
  .timeline-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  
  .timeline-body {
    padding: 10px 0;
  }
  
  .user-icon {
    font-size: 0.9rem;
    color: #6c757d;
  }

  /* Activity card design */
  .activity-card.bg-opacity-10 {
    border-width: 1px;
    border-style: solid;
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  
  .activity-card.bg-opacity-10:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  /* Custom border colors based on main.css */
  .border-primary-ea {
    border-color: #444a9f !important;
  }
  
  .border-secondary-ea {
    border-color: #9c85db !important;
  }
  
  .border-purple {
    border-color: #a44493 !important;
  }
  
  .border-tertiary-ea {
    border-color: #ff8568 !important;
  }
  
  .border-accent-ea {
    border-color: #f9f871 !important;
  }
  
  /* Custom background colors with opacity */
  .bg-primary-ea.bg-opacity-10 {
    background-color: rgba(68, 74, 159, 0.1) !important;
    border-color: rgba(68, 74, 159, 0.3) !important;
  }
  
  .bg-secondary-ea.bg-opacity-10 {
    background-color: rgba(156, 133, 219, 0.1) !important;
    border-color: rgba(156, 133, 219, 0.3) !important;
  }
  
  .bg-purple.bg-opacity-10 {
    background-color: rgba(164, 68, 147, 0.1) !important;
    border-color: rgba(164, 68, 147, 0.3) !important;
  }
  
  .bg-tertiary-ea.bg-opacity-10 {
    background-color: rgba(255, 133, 104, 0.1) !important;
    border-color: rgba(255, 133, 104, 0.3) !important;
  }
  
  .bg-accent-ea.bg-opacity-10 {
    background-color: rgba(249, 248, 113, 0.1) !important;
    border-color: rgba(249, 248, 113, 0.3) !important; 
  }
  
  /* Text colors */
  .text-primary-ea {
    color: #444a9f !important;
  }
  
  .text-secondary-ea {
    color: #9c85db !important;
  }
  
  .text-tertiary-ea {
    color: #ff8568 !important;
  }
  
  .text-accent-ea {
    color: #f9f871 !important;
  }

  /* Border top colors for activity cards */
  .border-top-primary-ea {
    border-top: 3px solid #444a9f !important; 
    border-radius: 0.375rem !important;
  }
  
  .border-top-secondary-ea {
    border-top: 3px solid #9c85db !important;
    border-radius: 0.375rem !important;
  }
  
  .border-top-purple {
    border-top: 3px solid #a44493 !important;
    border-radius: 0.375rem !important;
  }
  
  .border-top-tertiary-ea {
    border-top: 3px solid #ff8568 !important;
    border-radius: 0.375rem !important;
  }
  
  .border-top-accent-ea {
    border-top: 3px solid #f9f871 !important;
    border-radius: 0.375rem !important;
  }
  
  /* Activity icon styling */
  .activity-icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  /* Make list items cleaner */
  .list-group-item {
    border: none;
    border-bottom: 1px solid #eee !important;
  }
  
  /* Card shadow enhancements */
  .card.shadow-sm {
    box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card.shadow-sm:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
  }
</style>
{% endblock %}

{% block content %}
<!-- Company Profile Header -->
<div class="profile-header bg-gradient-blue-purple-left text-white py-4 mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2">{{ company.company_name }}</h1>
        <p class="mb-0">
          <i class="fas fa-building me-2"></i>
          {{ company.industry }}
          <span class="mx-2">|</span>
          <i class="fas fa-map-marker-alt me-2"></i>
          {{ company.city }}, {{ company.country }}
        </p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="{% url 'crm:company_list' %}" class="btn btn-light me-2">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
        <a href="{% url 'crm:company_update' company.pk %}" class="btn btn-light me-2">
          <i class="fas fa-edit"></i>
          Edit
        </a>
        <a href="{% url 'crm:contact_create' company_id=company.pk %}" class="btn btn-light">
          <i class="fas fa-user-plus"></i>
          Add Contact
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mb-5">
  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-4" id="companyTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">
        <i class="fas fa-info-circle me-2"></i>
        Overview
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="contacts-tab" data-bs-toggle="tab" href="#contacts" role="tab">
        <i class="fas fa-users me-2"></i>
        Contacts
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents" role="tab">
        <i class="fas fa-file-alt me-2"></i>
        Documents
      </a>
    </li>
    {% if company.company_type == 'Client' %}
    <li class="nav-item">
      <a
        class="nav-link"
        id="travel-policies-tab"
        data-bs-toggle="tab"
        href="#travel-policies"
        role="tab"
      >
        <i class="fas fa-plane me-2"></i>
        Travel Policies
      </a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link" id="activities-tab" data-bs-toggle="tab" href="#activities" role="tab">
        <i class="fas fa-chart-line me-2"></i>
        Activities
      </a>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="companyTabsContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-4">
          <!-- Basic Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Company Type</div>
                <div class="col-sm-7">{{ company.company_type }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Industry</div>
                <div class="col-sm-7">{{ company.industry }}</div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Email</div>
                <div class="col-sm-7">
                  <a href="mailto:{{ company.email }}">{{ company.email }}</a>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-5 text-muted">Phone</div>
                <div class="col-sm-7">
                  <a href="tel:{{ company.phone_number }}">{{ company.phone_number }}</a>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-5 text-muted">LinkedIn</div>
                <div class="col-sm-7">
                  {% if company.linkedin_social_page %}
                  <a href="{{ company.linkedin_social_page }}" target="_blank">
                    <i class="fab fa-linkedin"></i>
                    View Profile
                  </a>
                  {% else %}
                  <span class="text-muted">Not provided</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Address Information</h5>
            </div>
            <div class="card-body">
              <address class="mb-0">
                {{ company.street_address }}
                <br />
                {{ company.city }}, {{ company.state_province }} {{ company.postal_code }}
                <br />
                {{ company.country }}
              </address>
            </div>
          </div>

          <!-- Description -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Description</h5>
            </div>
            <div class="card-body">
              <p class="mb-0">{{ company.description|default:"No description provided." }}</p>
            </div>
          </div>

          {% if company.company_type == 'Client' or company.company_type == 'Supplier' %}
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Linked Companies</h5>
              <a
                href="{% url 'crm:manage_company_relationships' company.id %}"
                class="btn btn-primary btn-sm"
              >
                <i class="fas fa-link"></i>
                Manage
              </a>
            </div>
            <div class="card-body">
              {% if company.from_relationships.exists or company.to_relationships.exists %}
              <div class="list-group list-group-flush">
                {% for rel in company.from_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.to_company.id %}">
                          {{ rel.to_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Outgoing</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
                
                {% for rel in company.to_relationships.all %}
                  {% if rel.is_active %}
                  <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <a href="{% url 'crm:company_detail' rel.from_company.id %}">
                          {{ rel.from_company.company_name }}
                        </a>
                        <span class="badge bg-info ms-2">
                          {{ rel.get_relationship_type_display }}
                        </span>
                      </div>
                      <span class="badge bg-secondary">Incoming</span>
                    </div>
                    {% if rel.description %}
                    <small class="text-muted">{{ rel.description }}</small>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted">
                No linked companies found. Use the "Manage" button to link this company to others.
              </p>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header text-white card-header-primary">
              <h5 class="mb-0">
                {% if company.company_type == 'Client' %}
                Client
                {% else %}
                Supplier
                {% endif %}
                Profile
              </h5>
            </div>
            <div class="card-body">
              <!-- Basic Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                <div class="row">
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}Client{% else %}Supplier{% endif %}
                        Type
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_type }}
                        {% else %}
                          {{ company.supplier_profile.supplier_type }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">Status</label>
                      <span class="badge bg-primary">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_status }}
                        {% else %}
                          {{ company.supplier_profile.supplier_status }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Operations Team
                        {% else %}
                          Department
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.client_ops_team|default:"Not assigned" }}
                        {% else %}
                          {{ company.supplier_profile.supplier_for_department }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="mb-3">
                      <label class="text-muted d-block">
                        {% if company.company_type == 'Client' %}
                          Account Manager
                        {% else %}
                          Owner
                        {% endif %}
                      </label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {% if company.client_profile.client_account_manager %}
                            {{ company.client_profile.client_account_manager.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% else %}
                          {% if company.supplier_profile.supplier_owner %}
                            {{ company.supplier_profile.supplier_owner.get_full_name }}
                          {% else %}
                            Not assigned
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Finance/Invoice Information -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Finance/Invoice Information</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="text-muted d-block">Sage Name</label>
                      <span class="fs-6">
                        {{ company.client_profile.sage_name|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Midoco CRM Number</label>
                      <span class="fs-6">
                        {{ company.client_profile.midoco_crm_number|default:"Not set" }}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoice References</label>
                      {% if company.client_profile.invoice_reference_options.exists %}
                      <div class="mt-2">
                        {% for reference in company.client_profile.invoice_reference_options.all %}
                        <div class="badge bg-primary me-1 mb-1">
                          {{ reference.name }}
                          {% for client_ref in reference.clientinvoicereference_set.all %}
                            {% if client_ref.client_profile == company.client_profile %}
                            <span class="badge {% if client_ref.is_mandatory %}bg-danger{% else %}bg-secondary{% endif %} ms-1">
                              {% if client_ref.is_mandatory %}Mandatory{% else %}Optional{% endif %}
                            </span>
                            {% endif %}
                          {% endfor %}
                        </div>
                        {% endfor %}
                        
                        {% if not company.client_profile.invoice_reference_options.all %}
                          <span class="text-muted">No references set</span>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                  
                  <div class="col-md-{% if company.company_type == 'Client' %}6{% else %}12{% endif %}">
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Type</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_type|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_type|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Invoicing Frequency</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.invoicing_frequency|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.invoicing_frequency|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-3">
                      <label class="text-muted d-block">Payment Terms</label>
                      <span class="fs-6">
                        {% if company.company_type == 'Client' %}
                          {{ company.client_profile.payment_terms|default:"Not set" }}
                        {% else %}
                          {{ company.supplier_profile.payment_terms|default:"Not set" }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {% if company.company_type == 'Client' %}
              <!-- Corporate Benefits -->
              <div class="profile-section mb-4">
                <h6 class="border-bottom pb-2 mb-3">Corporate Benefits</h6>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Hotel Rates</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_hotel_rates|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Airline Fares</label>
                      <span class="fs-6">
                        {{ company.client_profile.corporate_airline_fares|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="text-muted d-block">Memberships</label>
                      <span class="fs-6">
                        {{ company.client_profile.company_memberships|default:"Not set" }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Service Status -->
              <div class="profile-section">
                <h6 class="border-bottom pb-2 mb-3">Service Status</h6>
                <div class="row">
                  {% if company.company_type == 'Client' %}
                  <div class="col-md-6">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.has_new_contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Contract Signed</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_corporate_schemes %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Corporate Schemes</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.signed_up_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.meetings_events_requirements %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Meetings & Events Requirements</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.reporting_standard_bespoke %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Standard/Bespoke Reporting</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.access_to_travelogix %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Access to Travelogix</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.travel_policy_health_check_offered %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Travel Policy Health Check Offered</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.testimonial_requested %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Testimonial Requested</span>
                      </li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="border-bottom pb-2 mb-3">Sustainability Information</h6>
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.communicated_esg_support %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>ESG Support Communicated</span>
                      </li>
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.client_profile.receive_co2_reporting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>CO2 Reporting</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.client_profile.discussed_offsetting %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Offsetting Discussed</span>
                      </li>
                    </ul>
                  </div>
                  {% else %}
                  <div class="col-12">
                    <ul class="list-unstyled status-list">
                      <li class="mb-2 d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.new_supplier_form_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>New Supplier Form Signed</span>
                      </li>
                      <li class="d-flex align-items-center">
                        <i class="fas {% if company.supplier_profile.contract_signed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        <span>Contract Signed</span>
                      </li>
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <table id="company-contacts-table" class="table table-striped">
            <thead>
              <tr>
                <th>Name</th>
                <th>Job Role</th>
                <th>Tags</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for contact in contacts %}
              <tr>
                <td>
                  <a href="{% url 'crm:contact_detail' contact.pk %}" class="fw-bold link-color">
                    {{ contact.first_name }} {{ contact.last_name }}
                  </a>
                </td>
                <td>{{ contact.job_role }}</td>
                <td>
                  {% for tag in contact.tag_list %}
                  <span
                    class="badge me-1 {% if tag == 'primary' %}bg-primary{% elif tag == 'key_personnel' %}bg-success{% elif tag == 'booker' %}bg-warning text-dark{% elif tag == 'vip_traveller' %}bg-warning{% elif tag == 'traveller' %}bg-info{% else %}bg-secondary{% endif %}"
                  >
                    {% if tag == 'primary' %} 
                      Primary Contact 
                    {% elif tag == 'key_personnel' %}
                      Key Personnel 
                    {% elif tag == 'booker' %} 
                      Booker 
                    {% elif tag == 'vip_traveller' %}
                      VIP Traveller 
                    {% elif tag == 'traveller' %} 
                      Traveller 
                    {% else %} 
                      {{ tag }}
                    {% endif %}
                  </span>
                  {% endfor %}
                </td>
                <td>
                  <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                </td>
                <td>
                  {% if contact.mobile %}
                  <a href="tel:{{ contact.mobile }}">{{ contact.mobile }}</a>
                  {% else %} 
                    {{ contact.landline|default:"-" }} 
                  {% endif %}
                </td>
                <td>{{ contact.created_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:contact_detail' contact.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:contact_update' contact.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center">
                  <p class="mb-0 py-3 text-muted">
                    <i class="fas fa-user me-2"></i>
                    There are no contacts available.
                  </p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Documents</h5>
          <a href="{% url 'crm:document_upload' company.id %}" class="btn btn-primary">
            <i class="fas fa-upload me-2"></i>Upload Document
          </a>
        </div>
        <div class="card-body">
          <table id="company-documents-table" class="table table-striped">
            <thead>
              <tr>
                <th>Document Name</th>
                <th>Document Type</th>
                <th>Uploaded By</th>
                <th>Uploaded Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for document in documents %}
              <tr>
                <td>
                  <a
                    href="{% url 'crm:document_detail' document.pk %}"
                    class="fw-bold link-color"
                  >
                    {{ document.document_name }}
                  </a>
                </td>
                <td>{{ document.document_type }}</td>
                <td>{{ document.uploaded_by.get_full_name }}</td>
                <td>{{ document.uploaded_at|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:document_detail' document.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:document_update' document.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <a
                      href="{% url 'crm:document_delete' document.pk %}"
                      class="btn btn-sm btn-danger"
                      title="Delete"
                    >
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  <p class="mb-0 py-3 text-muted">
                    <i class="fas fa-file-alt me-2"></i>
                    There are no documents available.
                  </p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if company.company_type == 'Client' %}
    <!-- Travel Policies Tab -->
    <div class="tab-pane fade" id="travel-policies" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Travel Policies</h5>
          <a href="{% url 'crm:travel_policy_create' company.id %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Policy
          </a>
        </div>
        <div class="card-body">
          <table id="company-travel-policies-table" class="table table-striped">
            <thead>
              <tr>
                <th>Policy Name</th>
                <th>Effective Date</th>
                <th>Status</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for policy in travel_policies %}
              <tr>
                <td>
                  <a
                    href="{% url 'crm:travel_policy_detail' policy.pk %}"
                    class="fw-bold link-color"
                  >
                    {{ policy.policy_name }}
                  </a>
                </td>
                <td>{{ policy.effective_date|date:"d M Y" }}</td>
                <td>
                  <span class="badge {% if policy.is_active %}bg-success{% else %}bg-danger{% endif %}">
                    {% if policy.is_active %}Active{% else %}Inactive{% endif %}
                  </span>
                </td>
                <td>{{ policy.last_updated|date:"d M Y" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <a
                      href="{% url 'crm:travel_policy_detail' policy.pk %}"
                      class="btn btn-sm action-btn-purple text-white"
                      title="View"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                    <a
                      href="{% url 'crm:travel_policy_update' policy.pk %}"
                      class="btn btn-sm btn-secondary-ea"
                      title="Edit"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <a
                      href="{% url 'crm:travel_policy_delete' policy.pk %}"
                      class="btn btn-sm btn-danger"
                      title="Delete"
                    >
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  <p class="mb-0 py-3 text-muted">
                    <i class="fas fa-plane-departure me-2"></i>
                    There are no travel policies available.
                  </p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Activities Tab -->
    <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Activity History</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logActivityModal">
                    <i class="fas fa-plus me-2"></i>Add Activity
                </button>
            </div>
            <div class="card-body">
                <div class="activity-list">
                    {% if activities %}
                        <ul class="list-group list-group-flush">
                            {% for activity in activities %}
                                <li class="list-group-item py-3 mb-2">
                                    {% if activity.activity_type in 'email,call,note,meeting,exception' %}
                                    <!-- User-added activities with card design -->
                                    <div class="d-flex">
                                        <div class="activity-icon me-3">
                                            <span class="activity-icon-wrapper rounded-circle p-2 
                                            {% if activity.activity_type == 'email' %}bg-primary-ea{% elif activity.activity_type == 'call' %}bg-secondary-ea{% elif activity.activity_type == 'meeting' %}bg-purple{% elif activity.activity_type == 'exception' %}bg-tertiary-ea{% else %}bg-accent-ea{% endif %} bg-opacity-25">
                                                <i class="fas 
                                                {% if activity.activity_type == 'email' %}fa-envelope text-primary-ea
                                                {% elif activity.activity_type == 'call' %}fa-phone-alt text-secondary-ea
                                                {% elif activity.activity_type == 'meeting' %}fa-users color-purple
                                                {% elif activity.activity_type == 'exception' %}fa-exclamation-triangle text-tertiary-ea
                                                {% else %}fa-sticky-note text-accent-ea
                                                {% endif %} fa-fw"></i>
                                            </span>
                                        </div>
                                        <div class="activity-content flex-grow-1">
                                            <div class="card shadow-sm mb-0 
                                                {% if activity.activity_type == 'email' %}border-top-primary-ea{% elif activity.activity_type == 'call' %}border-top-secondary-ea{% elif activity.activity_type == 'meeting' %}border-top-purple{% elif activity.activity_type == 'exception' %}border-top-tertiary-ea{% else %}border-top-accent-ea{% endif %}">
                                                <div class="card-body py-3">
                                                    <p class="mb-1">{{ activity.description }}</p>
                                                    <small class="text-muted">
                                                        <i class="far fa-clock me-1"></i>{{ activity.performed_at|date:"d M Y, H:i" }} 
                                                        <i class="far fa-user me-1 ms-2"></i>{{ activity.performed_by.get_full_name }}
                                                    </small>
                                                    
                                                    <div class="mt-2 text-end">
                                                        {% if activity.data %}
                                                        {{ activity.data|json_script:"activity-data-"|add:activity.id|safe }}
                                                        {% endif %}
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#activity-details-modal" 
                                                                data-activity-type="{{ activity.activity_type }}" 
                                                                data-activity-description="{{ activity.description }}"
                                                                data-activity-id="{{ activity.id }}"
                                                                data-activity-performed-at="{{ activity.performed_at|date:'d M Y, H:i' }}"
                                                                data-activity-performed-by="{{ activity.performed_by.get_full_name }}">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <!-- System updates with simple design -->
                                    <div class="d-flex">
                                        <div class="activity-icon me-3">
                                            <i class="fas 
                                            {% if activity.activity_type == 'status_change' %}fa-exchange-alt text-info
                                            {% elif activity.activity_type == 'document' %}fa-file-alt text-secondary
                                            {% elif activity.activity_type == 'policy_update' %}fa-clipboard-list text-info
                                            {% else %}fa-history text-secondary
                                            {% endif %} fa-fw"></i>
                                        </div>
                                        <div class="activity-content flex-grow-1">
                                            <p class="mb-1">{{ activity.description }}</p>
                                            <small class="text-muted">
                                                <i class="far fa-clock me-1"></i>{{ activity.performed_at|date:"d M Y, H:i" }} 
                                                <i class="far fa-user me-1 ms-2"></i>{{ activity.performed_by.get_full_name }}
                                            </small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="lead text-muted">No activities recorded for this company yet.</p>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#logActivityModal">
                                <i class="fas fa-plus me-2"></i>Log First Activity
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Activity Details Modal -->
<div
  class="modal fade"
  id="activity-details-modal"
  tabindex="-1"
  aria-labelledby="activity-details-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activity-details-modal-label"></h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="activity-details-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="edit-activity-btn">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button type="button" class="btn btn-danger" id="delete-activity-btn">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Activity Modal -->
<div
  class="modal fade"
  id="edit-activity-modal"
  tabindex="-1"
  aria-labelledby="edit-activity-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edit-activity-modal-label">Edit Activity</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="edit-activity-form-container">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading edit form...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Activity Confirmation Modal -->
<div
  class="modal fade"
  id="delete-activity-modal"
  tabindex="-1"
  aria-labelledby="delete-activity-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="delete-activity-modal-label">Confirm Delete</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this activity? This action cannot be undone.</p>
        <div id="delete-activity-details" class="alert alert-warning">
          <!-- Activity details will be shown here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Add the missing Log Activity Modal -->
<div class="modal fade" id="logActivityModal" tabindex="-1" aria-labelledby="logActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logActivityModalLabel">Log New Activity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Activity Type Selection -->
        <div class="mb-4">
          <h6 class="mb-3">Select Activity Type</h6>
          <div class="row row-cols-1 row-cols-md-3 g-3">
            <div class="col">
              <div class="card h-100 activity-type-card" data-activity-type="email">
                <div class="card-body text-center py-4">
                  <i class="fas fa-envelope fa-2x text-primary-ea mb-3"></i>
                  <h6 class="card-title">Email</h6>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100 activity-type-card" data-activity-type="call">
                <div class="card-body text-center py-4">
                  <i class="fas fa-phone-alt fa-2x text-secondary-ea mb-3"></i>
                  <h6 class="card-title">Call</h6>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100 activity-type-card" data-activity-type="note">
                <div class="card-body text-center py-4">
                  <i class="fas fa-sticky-note fa-2x text-accent-ea mb-3"></i>
                  <h6 class="card-title">Note</h6>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100 activity-type-card" data-activity-type="meeting">
                <div class="card-body text-center py-4">
                  <i class="fas fa-users fa-2x color-purple mb-3"></i>
                  <h6 class="card-title">Meeting</h6>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100 activity-type-card" data-activity-type="exception">
                <div class="card-body text-center py-4">
                  <i class="fas fa-exclamation-triangle fa-2x text-tertiary-ea mb-3"></i>
                  <h6 class="card-title">Waiver/Favor</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Forms Container - Will be populated based on selected type -->
        <div id="activity-form-container">
          <div class="text-center py-4">
            <p>Please select an activity type above to start logging.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Setup CSRF token for all AJAX requests
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  const csrftoken = getCookie('csrftoken');
  
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });

  let currentActivityId = null;
  let currentActivityData = null;
  let currentActivityType = null;

  $(document).ready(function() {
    // Activity Details Modal Event Handlers
    $('#activity-details-modal').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      const activityId = button.data('activity-id');
      const activityType = button.data('activity-type');
      currentActivityId = activityId;
      currentActivityType = activityType;
      
      const modal = $(this);
      
      // Set loading state
      modal.find('.modal-title').text('Loading...');
      modal.find('#activity-details-content').html(
        '<div class="text-center py-4">' +
        '<div class="spinner-border text-primary" role="status"></div>' +
        '<p class="mt-2">Loading activity details...</p>' +
        '</div>'
      );
      
      // Set title based on activity type
      if (activityType === 'email') {
        modal.find('.modal-title').text('Email Details');
      } else if (activityType === 'call') {
        modal.find('.modal-title').text('Call Details');
      } else if (activityType === 'note') {
        modal.find('.modal-title').text('Note Details');
      } else if (activityType === 'meeting') {
        modal.find('.modal-title').text('Meeting Details');
      } else if (activityType === 'exception') {
        modal.find('.modal-title').text('Waiver/Favor Details');
      }
      
      // Fetch activity details from API
      $.ajax({
        url: '{% url "crm:activity_details" 0 %}'.replace('0', activityId),
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          let contentHtml = '';
          
          // Store the current activity data for edit/delete modals
          currentActivityData = data;
          
          // Format based on activity type
          if (activityType === 'email') {
            contentHtml = `
              <div class="mb-3">
                <strong>Subject:</strong> ${data.data.subject || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Recipients:</strong> ${data.data.recipient_names ? data.data.recipient_names.join(', ') : 'No recipients'}
              </div>
              <div class="mb-3">
                <strong>Message:</strong>
                <div class="p-3 bg-light rounded">${data.data.content || 'No content'}</div>
              </div>
            `;
          } else if (activityType === 'call') {
            contentHtml = `
              <div class="mb-3">
                <strong>Contact:</strong> ${data.data.contact_name || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Duration:</strong> ${data.data.duration ? data.data.duration + ' minutes' : 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Summary:</strong>
                <div class="p-3 bg-light rounded">${data.data.summary || 'No summary'}</div>
              </div>
            `;
          } else if (activityType === 'note') {
            contentHtml = `
              <div class="mb-3">
                <strong>Note:</strong>
                <div class="p-3 bg-light rounded">${data.data.content || 'No content'}</div>
              </div>
            `;
          } else if (activityType === 'meeting') {
            contentHtml = `
              <div class="mb-3">
                <strong>Title:</strong> ${data.data.title || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Date:</strong> ${data.data.date || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Time:</strong> ${data.data.start_time || 'N/A'} - ${data.data.end_time || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Location:</strong> ${data.data.location || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Attendees:</strong> ${data.data.attendee_names ? data.data.attendee_names.join(', ') : 'None specified'}
              </div>
              <div class="mb-3">
                <strong>Notes:</strong>
                <div class="p-3 bg-light rounded">${data.data.notes || 'No notes'}</div>
              </div>
            `;
          } else if (activityType === 'exception') {
            contentHtml = `
              <div class="mb-3">
                <strong>Type:</strong> ${data.data.exception_type ? data.data.exception_type.replace('_', ' ').toUpperCase() : 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Value:</strong> ${data.data.value_amount ? '£' + data.data.value_amount : 'N/A'}
              </div>
              <div class="mb-3">
                <strong>For Contact:</strong> ${data.data.contact_name || 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Approved By:</strong> ${data.data.approved_by ? data.data.approved_by.replace('_', ' ').toUpperCase() : 'N/A'}
              </div>
              <div class="mb-3">
                <strong>Description:</strong>
                <div class="p-3 bg-light rounded">${data.data.description || 'No description'}</div>
              </div>
            `;
          }
          
          // Add meta information
          contentHtml += `
            <div class="mt-4 pt-3 border-top text-muted small">
              <div><i class="far fa-clock me-1"></i> ${data.performed_at}</div>
              <div><i class="far fa-user me-1"></i> ${data.performed_by}</div>
            </div>
          `;
          
          modal.find('#activity-details-content').html(contentHtml);
        },
        error: function(xhr, status, error) {
          modal.find('#activity-details-content').html(
            '<div class="alert alert-danger">' +
            '<i class="fas fa-exclamation-triangle me-2"></i>' +
            'Unable to load activity details.' +
            '</div>'
          );
        }
      });
    });
    
    // Edit button handler
    $('#edit-activity-btn').on('click', function() {
      // Hide activity details modal
      $('#activity-details-modal').modal('hide');
      
      // Open edit modal
      setTimeout(function() {
        const editModal = $('#edit-activity-modal');
        
        // Set modal title
        if (currentActivityType === 'email') {
          editModal.find('.modal-title').text('Edit Email');
        } else if (currentActivityType === 'call') {
          editModal.find('.modal-title').text('Edit Call');
        } else if (currentActivityType === 'note') {
          editModal.find('.modal-title').text('Edit Note');
        } else if (currentActivityType === 'meeting') {
          editModal.find('.modal-title').text('Edit Meeting');
        } else if (currentActivityType === 'exception') {
          editModal.find('.modal-title').text('Edit Waiver/Favor');
        }
        
        // Build the edit form based on activity type
        let formHtml = `
          <form id="edit-activity-form">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
            <input type="hidden" name="activity_id" value="${currentActivityId}">
            
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <input type="text" class="form-control" id="description" name="description" value="${currentActivityData.description}" required>
            </div>
        `;
        
        // Add fields based on activity type
        if (currentActivityType === 'note') {
          formHtml += `
            <div class="mb-3">
              <label for="content" class="form-label">Content</label>
              <textarea class="form-control" id="content" name="content" rows="5" required>${currentActivityData.data.content || ''}</textarea>
            </div>
          `;
        } else if (currentActivityType === 'call') {
          formHtml += `
            <div class="mb-3">
              <label for="contact_id" class="form-label">Contact</label>
              <select class="form-select" id="contact_id" name="contact_id">
                <option value="">No specific contact</option>
                <!-- Contacts will be loaded dynamically -->
              </select>
            </div>
            
            <div class="mb-3">
              <label for="duration" class="form-label">Duration (minutes)</label>
              <input type="number" class="form-control" id="duration" name="duration" value="${currentActivityData.data.duration || ''}">
            </div>
            
            <div class="mb-3">
              <label for="summary" class="form-label">Summary</label>
              <textarea class="form-control" id="summary" name="summary" rows="4">${currentActivityData.data.summary || ''}</textarea>
            </div>
          `;
        } else if (currentActivityType === 'email') {
          formHtml += `
            <div class="mb-3">
              <label for="subject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="subject" name="subject" value="${currentActivityData.data.subject || ''}">
            </div>
            
            <div class="mb-3">
              <label for="recipients" class="form-label">Recipients</label>
              <select class="form-select" id="recipients" name="recipients" multiple>
                <!-- Recipients will be loaded dynamically -->
              </select>
              <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple contacts</small>
            </div>
            
            <div class="mb-3">
              <label for="content" class="form-label">Content</label>
              <textarea class="form-control" id="content" name="content" rows="5">${currentActivityData.data.content || ''}</textarea>
            </div>
          `;
        } else if (currentActivityType === 'meeting') {
          formHtml += `
            <div class="mb-3">
              <label for="title" class="form-label">Title</label>
              <input type="text" class="form-control" id="title" name="title" value="${currentActivityData.data.title || ''}">
            </div>
            
            <div class="mb-3">
              <label for="date" class="form-label">Date</label>
              <input type="date" class="form-control" id="date" name="date" value="${currentActivityData.data.date || ''}">
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="start_time" class="form-label">Start Time</label>
                  <input type="time" class="form-control" id="start_time" name="start_time" value="${currentActivityData.data.start_time || ''}">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="end_time" class="form-label">End Time</label>
                  <input type="time" class="form-control" id="end_time" name="end_time" value="${currentActivityData.data.end_time || ''}">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="location" class="form-label">Location</label>
              <input type="text" class="form-control" id="location" name="location" value="${currentActivityData.data.location || ''}">
            </div>
            
            <div class="mb-3">
              <label for="attendees" class="form-label">Attendees</label>
              <select class="form-select" id="attendees" name="attendees" multiple>
                <!-- Attendees will be loaded dynamically -->
              </select>
              <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple attendees</small>
            </div>
            
            <div class="mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea class="form-control" id="notes" name="notes" rows="4">${currentActivityData.data.notes || ''}</textarea>
            </div>
          `;
        } else if (currentActivityType === 'exception') {
          formHtml += `
            <div class="mb-3">
              <label for="exception_type" class="form-label">Type</label>
              <select class="form-select" id="exception_type" name="exception_type">
                <option value="refund_waiver" ${currentActivityData.data.exception_type === 'refund_waiver' ? 'selected' : ''}>Refund Waiver</option>
                <option value="fee_waiver" ${currentActivityData.data.exception_type === 'fee_waiver' ? 'selected' : ''}>Fee Waiver</option>
                <option value="loyalty_points" ${currentActivityData.data.exception_type === 'loyalty_points' ? 'selected' : ''}>Loyalty Points</option>
                <option value="rate_match" ${currentActivityData.data.exception_type === 'rate_match' ? 'selected' : ''}>Rate Match</option>
                <option value="other" ${currentActivityData.data.exception_type === 'other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="value_amount" class="form-label">Value Amount (£)</label>
              <input type="number" step="0.01" class="form-control" id="value_amount" name="value_amount" value="${currentActivityData.data.value_amount || ''}">
            </div>
            
            <div class="mb-3">
              <label for="contact_id" class="form-label">For Contact</label>
              <select class="form-select" id="contact_id" name="contact_id">
                <option value="">No specific contact</option>
                <!-- Contacts will be loaded dynamically -->
              </select>
            </div>
            
            <div class="mb-3">
              <label for="approved_by" class="form-label">Approved By</label>
              <select class="form-select" id="approved_by" name="approved_by">
                <option value="manager" ${currentActivityData.data.approved_by === 'manager' ? 'selected' : ''}>Manager</option>
                <option value="director" ${currentActivityData.data.approved_by === 'director' ? 'selected' : ''}>Director</option>
                <option value="operations" ${currentActivityData.data.approved_by === 'operations' ? 'selected' : ''}>Operations</option>
                <option value="account_manager" ${currentActivityData.data.approved_by === 'account_manager' ? 'selected' : ''}>Account Manager</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="exception_description" class="form-label">Description</label>
              <textarea class="form-control" id="exception_description" name="exception_description" rows="4">${currentActivityData.data.description || ''}</textarea>
            </div>
          `;
        }
        
        // Add form footer and close the form
        formHtml += `
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        `;
        
        // Set form in the modal
        editModal.find('#edit-activity-form-container').html(formHtml);
        
        // Load contacts for dropdown selects if needed
        if (['call', 'email', 'meeting', 'exception'].includes(currentActivityType)) {
          $.ajax({
            url: '{% url "crm:company_detail" company.id %}',
            data: { 'get_contacts': 'true' },
            type: 'GET',
            dataType: 'json',
            success: function(data) {
              if (data.contacts && data.contacts.length > 0) {
                let contactOptions = '';
                data.contacts.forEach(function(contact) {
                  const contactId = contact.id.toString();
                  
                  // For call and exception contact fields
                  if (['call', 'exception'].includes(currentActivityType)) {
                    const selected = contactId === (currentActivityData.data.contact_id || '').toString() ? 'selected' : '';
                    contactOptions += `<option value="${contactId}" ${selected}>${contact.first_name} ${contact.last_name}</option>`;
                  }
                });
                
                // Update contact select options
                if (['call', 'exception'].includes(currentActivityType)) {
                  $('#contact_id').append(contactOptions);
                }
                
                // For email recipients
                if (currentActivityType === 'email' && data.contacts.length > 0) {
                  let recipientOptions = '';
                  data.contacts.forEach(function(contact) {
                    const contactId = contact.id.toString();
                    const selected = currentActivityData.data.recipients && currentActivityData.data.recipients.includes(contactId) ? 'selected' : '';
                    recipientOptions += `<option value="${contactId}" ${selected}>${contact.first_name} ${contact.last_name}</option>`;
                  });
                  $('#recipients').append(recipientOptions);
                }
                
                // For meeting attendees
                if (currentActivityType === 'meeting' && data.contacts.length > 0) {
                  let attendeeOptions = '';
                  data.contacts.forEach(function(contact) {
                    const contactId = contact.id.toString();
                    const selected = currentActivityData.data.attendees && currentActivityData.data.attendees.includes(contactId) ? 'selected' : '';
                    attendeeOptions += `<option value="${contactId}" ${selected}>${contact.first_name} ${contact.last_name}</option>`;
                  });
                  $('#attendees').append(attendeeOptions);
                }
              }
            }
          });
        }
        
        // Initialize Select2 for multiple selects if needed
        if (['email', 'meeting'].includes(currentActivityType)) {
          setTimeout(function() {
            if ($.fn.select2) {
              $('#recipients, #attendees').select2({
                placeholder: 'Select contacts',
                width: '100%'
              });
            }
          }, 100);
        }
        
        // Handle form submission
        $('#edit-activity-form').on('submit', function(e) {
          e.preventDefault();
          
          const formData = $(this).serialize();
          
          $.ajax({
            url: '{% url "crm:edit_activity" 0 %}'.replace('0', currentActivityId),
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
              $('#edit-activity-modal').modal('hide');
              
              // Don't create manual alerts - Django messages will handle this
              // Refresh the activities list without delay
              location.reload();
            },
            error: function(xhr, status, error) {
              let errorMessage = 'An error occurred while updating the activity.';
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
              }
              
              $('#edit-activity-form-container').prepend(`
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  ${errorMessage}
                </div>
              `);
            }
          });
        });
        
        // Show edit modal
        editModal.modal('show');
      }, 500);
    });
    
    // Delete button handler
    $('#delete-activity-btn').on('click', function() {
      // Hide activity details modal
      $('#activity-details-modal').modal('hide');
      
      // Open delete confirmation modal
      setTimeout(function() {
        const deleteModal = $('#delete-activity-modal');
        
        // Set activity description in confirmation
        const activityDescription = currentActivityData.description;
        const activityPerformedAt = currentActivityData.performed_at;
        
        $('#delete-activity-details').html(`
          <strong>Activity:</strong> ${activityDescription}<br>
          <strong>Date:</strong> ${activityPerformedAt}
        `);
        
        // Handle delete confirmation
        $('#confirm-delete-btn').off('click').on('click', function() {
          $.ajax({
            url: '{% url "crm:delete_activity" 0 %}'.replace('0', currentActivityId),
            type: 'POST',
            data: {
              'csrfmiddlewaretoken': csrftoken
            },
            dataType: 'json',
            success: function(response) {
              deleteModal.modal('hide');
              
              // Don't create manual alerts - Django messages will handle this
              // Refresh the activities list without delay
              location.reload();
            },
            error: function(xhr, status, error) {
              let errorMessage = 'An error occurred while deleting the activity.';
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
              }
              
              deleteModal.find('.modal-body').prepend(`
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  ${errorMessage}
                </div>
              `);
            }
          });
        });
        
        // Show delete modal
        deleteModal.modal('show');
      }, 500);
    });
  });

  // Add the activity type selection handling
  // Handle activity type selection in logActivityModal
  const activityTypeCards = document.querySelectorAll('.activity-type-card');
  const formContainer = document.getElementById('activity-form-container');
  let currentActivityType = null;

  // Function to show the selected form
  function showSelectedForm(activityType) {
    // Remove active class from all cards
    activityTypeCards.forEach(card => {
      card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`.activity-type-card[data-activity-type="${activityType}"]`);
    if (selectedCard) {
      selectedCard.classList.add('active');
    }
    
    // Show loading indicator
    formContainer.innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Loading form...</p>
      </div>
    `;
    
    // Create the form HTML based on activity type
    let formHtml = `
      <form id="log-activity-form" method="post" action="/crm/companies/{{ company.id }}/log-activity/${activityType}/">
        {% csrf_token %}
    `;
    
    // Build different forms based on activity type
    if (activityType === 'email') {
      formHtml += `
        <div class="mb-3">
          <label for="subject" class="form-label">Subject</label>
          <input type="text" class="form-control" id="subject" name="subject" required>
        </div>
        
        <div class="mb-3">
          <label for="recipients" class="form-label">Recipients</label>
          <select class="form-select" id="recipients" name="recipients" multiple>
            {% for contact in company.contacts.all %}
              <option value="{{ contact.id }}">{{ contact.first_name }} {{ contact.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-3">
          <label for="content" class="form-label">Email Content</label>
          <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
        </div>
      `;
    } else if (activityType === 'call') {
      formHtml += `
        <div class="mb-3">
          <label for="contact" class="form-label">Contact</label>
          <select class="form-select" id="contact" name="contact">
            <option value="">No specific contact</option>
            {% for contact in company.contacts.all %}
              <option value="{{ contact.id }}">{{ contact.first_name }} {{ contact.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-3">
          <label for="duration" class="form-label">Duration (minutes)</label>
          <input type="number" class="form-control" id="duration" name="duration">
        </div>
        
        <div class="mb-3">
          <label for="summary" class="form-label">Call Summary</label>
          <textarea class="form-control" id="summary" name="summary" rows="4" required></textarea>
        </div>
      `;
    } else if (activityType === 'note') {
      formHtml += `
        <div class="mb-3">
          <label for="content" class="form-label">Note Content</label>
          <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
        </div>
      `;
    } else if (activityType === 'meeting') {
      formHtml += `
        <div class="mb-3">
          <label for="title" class="form-label">Meeting Title</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        
        <div class="mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" required>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="start_time" class="form-label">Start Time</label>
              <input type="time" class="form-control" id="start_time" name="start_time" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="end_time" class="form-label">End Time</label>
              <input type="time" class="form-control" id="end_time" name="end_time" required>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="location" class="form-label">Location</label>
          <input type="text" class="form-control" id="location" name="location">
        </div>
        
        <div class="mb-3">
          <label for="attendees" class="form-label">Attendees</label>
          <select class="form-select" id="attendees" name="attendees" multiple>
            {% for contact in company.contacts.all %}
              <option value="{{ contact.id }}">{{ contact.first_name }} {{ contact.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-3">
          <label for="notes" class="form-label">Meeting Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="4"></textarea>
        </div>
      `;
    } else if (activityType === 'exception') {
      formHtml += `
        <div class="mb-3">
          <label for="exception_type" class="form-label">Type</label>
          <select class="form-select" id="exception_type" name="exception_type" required>
            <option value="refund_waiver">Refund Waiver</option>
            <option value="fee_waiver">Fee Waiver</option>
            <option value="loyalty_points">Loyalty Points</option>
            <option value="rate_match">Rate Match</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label for="value_amount" class="form-label">Value Amount (£)</label>
          <input type="number" step="0.01" class="form-control" id="value_amount" name="value_amount">
        </div>
        
        <div class="mb-3">
          <label for="contact" class="form-label">For Contact</label>
          <select class="form-select" id="contact" name="contact">
            <option value="">No specific contact</option>
            {% for contact in company.contacts.all %}
              <option value="{{ contact.id }}">{{ contact.first_name }} {{ contact.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-3">
          <label for="approved_by" class="form-label">Approved By</label>
          <select class="form-select" id="approved_by" name="approved_by" required>
            <option value="manager">Manager</option>
            <option value="director">Director</option>
            <option value="operations">Operations</option>
            <option value="account_manager">Account Manager</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
        </div>
      `;
    }
    
    // Add submit button and close form
    formHtml += `
        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Activity</button>
        </div>
      </form>
    `;
    
    // Update the form container
    formContainer.innerHTML = formHtml;
    
    // Initialize Select2 for multiple selects if needed
    if (window.jQuery && $.fn.select2 && ['email', 'meeting'].includes(activityType)) {
      $('#recipients, #attendees').select2({
        width: '100%',
        placeholder: 'Select contacts'
      });
    }
    
    // Store the current activity type
    currentActivityType = activityType;
  }
  
  // Add click handlers to activity type cards
  activityTypeCards.forEach(card => {
    card.addEventListener('click', function() {
      const activityType = this.dataset.activityType;
      showSelectedForm(activityType);
    });
  });
  
  // Show email form by default when modal is opened
  $('#logActivityModal').on('shown.bs.modal', function() {
    const emailCard = document.querySelector('.activity-type-card[data-activity-type="email"]');
    if (emailCard) {
      emailCard.click();
    }
  });
});
</script>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<!-- DataTables and Responsive extension -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<script src="{% static 'js/company_detail.js' %}"></script>
<script src="{% static 'js/tab_handler.js' %}"></script>
{% endblock extra_js %}

{% include 'crm/includes/invoice_remarks_modal.html' %}
{% block postload_js %}{% endblock postload_js %}
