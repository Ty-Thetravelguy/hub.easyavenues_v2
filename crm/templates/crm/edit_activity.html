{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Activity{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Edit {{ activity.get_activity_type_display }}</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="activity_id" value="{{ activity.id }}">
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" value="{{ activity.description }}" required>
                        </div>
                        
                        {% if activity.activity_type == 'note' %}
                        <!-- Note Fields -->
                        <div class="mb-3">
                            <label for="content" class="form-label">Content</label>
                            <textarea class="form-control" id="content" name="content" rows="5" required>{{ activity_data.content }}</textarea>
                        </div>
                        
                        {% elif activity.activity_type == 'call' %}
                        <!-- Call Fields -->
                        <div class="mb-3">
                            <label for="contact_id" class="form-label">Contact</label>
                            <select class="form-select" id="contact_id" name="contact_id">
                                <option value="">No specific contact</option>
                                {% for contact in contacts %}
                                <option value="{{ contact.id }}" {% if activity_data.contact_id == contact.id %}selected{% endif %}>
                                    {{ contact.first_name }} {{ contact.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duration" class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="duration" name="duration" value="{{ activity_data.duration }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="summary" class="form-label">Summary</label>
                            <textarea class="form-control" id="summary" name="summary" rows="4">{{ activity_data.summary }}</textarea>
                        </div>
                        
                        {% elif activity.activity_type == 'email' %}
                        <!-- Email Fields -->
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject" value="{{ activity_data.subject }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="recipients" class="form-label">Recipients</label>
                            <select class="form-select" id="recipients" name="recipients" multiple>
                                {% for contact in contacts %}
                                <option value="{{ contact.id }}" 
                                    {% if activity_data.recipients and contact.id|stringformat:"s" in activity_data.recipients %}selected{% endif %}>
                                    {{ contact.first_name }} {{ contact.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple contacts</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="content" class="form-label">Content</label>
                            <textarea class="form-control" id="content" name="content" rows="5">{{ activity_data.content }}</textarea>
                        </div>
                        
                        {% elif activity.activity_type == 'meeting' %}
                        <!-- Meeting Fields -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ activity_data.title }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ activity_data.date }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_time" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="start_time" name="start_time" value="{{ activity_data.start_time }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_time" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="end_time" name="end_time" value="{{ activity_data.end_time }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" value="{{ activity_data.location }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="attendees" class="form-label">Attendees</label>
                            <select class="form-select" id="attendees" name="attendees" multiple>
                                {% for contact in contacts %}
                                <option value="{{ contact.id }}"
                                    {% if activity_data.attendees and contact.id|stringformat:"s" in activity_data.attendees %}selected{% endif %}>
                                    {{ contact.first_name }} {{ contact.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple attendees</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="4">{{ activity_data.notes }}</textarea>
                        </div>
                        
                        {% elif activity.activity_type == 'exception' %}
                        <!-- Waiver/Favor Fields -->
                        <div class="mb-3">
                            <label for="exception_type" class="form-label">Type</label>
                            <select class="form-select" id="exception_type" name="exception_type">
                                <option value="refund_waiver" {% if activity_data.exception_type == 'refund_waiver' %}selected{% endif %}>Refund Waiver</option>
                                <option value="fee_waiver" {% if activity_data.exception_type == 'fee_waiver' %}selected{% endif %}>Fee Waiver</option>
                                <option value="loyalty_points" {% if activity_data.exception_type == 'loyalty_points' %}selected{% endif %}>Loyalty Points</option>
                                <option value="rate_match" {% if activity_data.exception_type == 'rate_match' %}selected{% endif %}>Rate Match</option>
                                <option value="other" {% if activity_data.exception_type == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="value_amount" class="form-label">Value Amount (Â£)</label>
                            <input type="number" step="0.01" class="form-control" id="value_amount" name="value_amount" value="{{ activity_data.value_amount }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="contact_id" class="form-label">For Contact</label>
                            <select class="form-select" id="contact_id" name="contact_id">
                                <option value="">No specific contact</option>
                                {% for contact in contacts %}
                                <option value="{{ contact.id }}" {% if activity_data.contact_id == contact.id %}selected{% endif %}>
                                    {{ contact.first_name }} {{ contact.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="approved_by" class="form-label">Approved By</label>
                            <select class="form-select" id="approved_by" name="approved_by">
                                <option value="manager" {% if activity_data.approved_by == 'manager' %}selected{% endif %}>Manager</option>
                                <option value="director" {% if activity_data.approved_by == 'director' %}selected{% endif %}>Director</option>
                                <option value="operations" {% if activity_data.approved_by == 'operations' %}selected{% endif %}>Operations</option>
                                <option value="account_manager" {% if activity_data.approved_by == 'account_manager' %}selected{% endif %}>Account Manager</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="4">{{ activity_data.description }}</textarea>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'crm:company_detail' activity.company.id %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Add any JavaScript specific to this form
    {% if activity.activity_type in 'email,meeting' %}
    $('#recipients, #attendees').select2({
        placeholder: 'Select contacts',
        width: '100%'
    });
    {% endif %}
});
</script>
{% endblock %} 